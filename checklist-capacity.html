<!-- ✅ UPDATED FULL PAGE (Single File, Works End-to-End)
     ✅ HARD LOCK behind sign-in (tool UI disabled + overlay)
     ✅ Save Item (My Playbook bookmark) localStorage
     ✅ Cloud progress saves ONLY when user presses "Save Progress"
     ✅ Supabase single module (no redeclare errors)
     ✅ Fixes missing helpers (getAuthedUser / planLabel / initialsFrom)
     ✅ Fixes duplicate setToolLocked()
     ✅ Uses FA6-safe checkbox icon toggles (far↔fas)
-->

<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Capacity Checklist | The Employee Playbook</title>

  <!-- Basic metadata -->
  <meta name="description" content="Capacity Checklist — turn overwhelm into evidence. Track workload reality, generate a report, and save progress to your account." />
  <meta name="robots" content="index,follow" />

  <!-- ICONS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">

  <!-- THEME PRELOAD (prevents flash; CSS expects body.dark-mode) -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme'); // "dark" | "light" | null
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.documentElement.classList.add('preload-dark');
      } catch (e) {}
    })();
  </script>

  <!-- Supabase project config (YOU maintain keys in this file) -->
  <script src="assets/supabase-config.js"></script>

  <style>
    /* ===========================
       ROOT VARIABLES (From Homepage + Canonical Category Colours)
    =========================== */
    :root {
      --primary-white: #FFFFFF;
      --light-gray: #F8F9FA;
      --medium-gray: #E9ECEF;
      --dark-gray: #6C757D;
      --text-dark: #212529;
      --text-medium: #495057;
      --accent-purple: #7B5FC4;
      --accent-purple-dark: #5A4496;
      --light-purple: #E6E0F5;
      --lighter-purple: #F0EBFA;
      --border-light: rgba(0, 0, 0, 0.08);
      --hero-gray: #f5f7fa;
      --nav-bg: rgba(255, 255, 255, 0.95);
      --hero-bg: linear-gradient(135deg, #F9F6FF 0%, #F0EBFA 100%);
      --premium-gradient: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --danger-red: #ef4444;
      --info-blue: #3b82f6;
      --capacity-green: #059669;
      --capacity-yellow: #d97706;
      --capacity-red: #dc2626;

      /* Canonical category tokens */
      --category-clarity: #7B5FC4;
      --category-burnout: #f59e0b;
      --category-manager: #10b981;
      --category-politics: #3b82f6;
      --category-hr: #6D28D9;
      --category-confidence: #ef4444;
      --category-career: #800020;
    }

    /* Dark Mode Variables */
    .dark-mode {
      --primary-white: #1a1a1a;
      --light-gray: #2a2a2a;
      --medium-gray: #3a3a3a;
      --dark-gray: #888888;
      --text-dark: #e0e0e0;
      --text-medium: #b0b0b0;
      --accent-purple: #9d86e9;
      --accent-purple-dark: #7b5fc4;
      --light-purple: rgba(123, 95, 196, 0.2);
      --lighter-purple: rgba(123, 95, 196, 0.1);
      --border-light: rgba(255, 255, 255, 0.08);
      --hero-gray: #2a2a2a;
      --nav-bg: rgba(30, 30, 30, 0.95);
      --hero-bg: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      --premium-gradient: linear-gradient(135deg, #9d86e9 0%, #7b5fc4 100%);
      --capacity-green: #10b981;
      --capacity-yellow: #f59e0b;
      --capacity-red: #ef4444;
    }

    /* ===========================
       GLOBAL STYLES
    =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    html { scroll-behavior: smooth; }

    body {
      background-color: var(--primary-white);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.4s ease, background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    html.preload-dark body { background-color: #1a1a1a; color: #e0e0e0; }
    body.loaded { opacity: 1; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===========================
       NAVIGATION (POST-LOGIN HEADER)
    =========================== */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000;
      border-bottom: 1px solid var(--border-light);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease, border-color 0.3s ease;
      height: 80px;
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      height: 100%;
    }

    .logo { display: block; text-decoration: none; }

    .logo-img {
      height: 100px;
      width: auto;
      transform: translateX(20%);
      padding: 14px 10px;
      transition: all 0.3s ease;
      display: block;
      min-height: 100px;
    }

    .logo-fallback {
      display: none;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
      text-decoration: none;
    }

    /* TEMPLATE MATCH: move nav links left */
    .nav-links {
      display: flex;
      gap: 50px;
      transform: translateX(-28px);
    }

    .nav-link {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      font-size: 17px;
      position: relative;
    }

    .nav-link:hover { color: var(--accent-purple); }

    .nav-link.active { color: var(--text-dark); }
    .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -7px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent-purple);
      border-radius: 2px 2px 0 0;
    }

    .nav-link-container { position: relative; display: inline-block; }

    .new-tag {
      position: absolute;
      top: -12px;
      right: -35px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
      white-space: nowrap;
    }

    .dark-mode .new-tag { box-shadow: 0 2px 4px rgba(0,0,0,0.4); }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateX(-28%);
    }

    .user-initials {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 0.5px;
      color: var(--text-dark);
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      transition: all 0.25s ease;
      user-select: none;
      flex: 0 0 auto;
    }

    .user-initials:hover {
      transform: translateY(-1px);
      border-color: rgba(123, 95, 196, 0.35);
      box-shadow: 0 8px 18px rgba(123, 95, 196, 0.12);
      color: var(--accent-purple);
    }

    .dark-mode .user-initials {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      color: var(--text-dark);
    }

    .dark-mode .user-initials:hover {
      border-color: rgba(139,108,230,0.35);
      box-shadow: 0 10px 22px rgba(139,108,230,0.14);
      color: var(--accent-purple);
    }

    /* Plan pill */
    .plan-pill {
      display: inline-flex;
      align-items: center;
      height: 28px;
      padding: 0 10px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: var(--text-dark);
      background: var(--lighter-purple);
      border: 1px solid rgba(123,95,196,0.18);
      box-shadow: 0 6px 16px rgba(123,95,196,0.08);
      user-select: none;
      white-space: nowrap;
      transition: all 0.25s ease;
    }

    .dark-mode .plan-pill {
      color: var(--text-dark);
      background: rgba(139,108,230,0.14);
      border-color: rgba(139,108,230,0.22);
      box-shadow: 0 10px 20px rgba(0,0,0,0.22);
    }

    .logout-link {
      display: none;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-medium);
      text-decoration: none;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.7);
      transition: all .2s ease;
      cursor: pointer;
      user-select: none;
    }
    .logout-link:hover {
      transform: translateY(-1px);
      border-color: rgba(123, 95, 196, 0.35);
      color: var(--accent-purple-dark);
      box-shadow: 0 8px 18px rgba(123, 95, 196, 0.10);
    }
    .dark-mode .logout-link {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      color: var(--text-medium);
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    .theme-toggle:hover { background-color: var(--light-gray); }

    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    .mobile-toggle:hover { background-color: var(--light-gray); }

    .mobile-profile {
      display: none;
      margin-top: 10px;
      padding: 12px 20px;
      background: var(--accent-purple);
      color: white;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      text-decoration: none;
    }

    .mobile-cta-tab {
      display: none;
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%) rotate(-90deg);
      transform-origin: right bottom;
      background: var(--accent-purple);
      color: white;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 5px 15px rgba(123, 95, 196, 0.4);
      z-index: 998;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    .mobile-cta-tab:hover { background: var(--accent-purple-dark); }

    @media (max-width: 992px) {
      .nav-links { gap: 30px; }
      .nav-actions { gap: 12px; }
      .plan-pill { display: none; }
    }

    @media (max-width: 768px) {
      .nav-container { justify-content: center; position: relative; }

      .logo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        height: 100%;
      }

      .logo-img {
        height: 125px;
        transform: none;
        padding: 12px 0;
      }

      .mobile-toggle {
        display: flex;
        position: absolute;
        left: 20px;
        align-items: center;
      }

      .nav-actions {
        transform: none;
        gap: 12px;
        position: absolute;
        right: 20px;
        align-items: center;
      }

      .nav-actions .user-initials { display: none; }
      .nav-actions .plan-pill { display: none; }
      .nav-actions .logout-link { display: none !important; }

      .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: var(--nav-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        flex-direction: column;
        padding: 20px;
        border-top: 1px solid var(--border-light);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        gap: 20px;
        transform: none;
      }

      .nav-links.active { display: flex; }
      .nav-link-container { display: flex; width: 100%; }
      .new-tag { position: static; margin-left: 8px; }

      .mobile-profile { display: block !important; }
      .mobile-cta-tab { display: block; }
    }

    /* ===========================
       HERO SECTION
    =========================== */
    .tool-hero-section {
      width: 100%;
      background: var(--hero-bg);
      padding: 20px 0 30px;
      margin-top: 110px;
      position: relative;
      border-bottom: 1px solid var(--border-light);
      overflow: hidden;
    }

    .tool-hero-section::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 100%;
      background: linear-gradient(135deg, rgba(250, 245, 255, 0.85) 0%, rgba(245, 240, 255, 0.6) 50%, rgba(255, 255, 255, 0.25) 100%);
      z-index: 1;
    }

    .dark-mode .tool-hero-section::before {
      background: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(31, 31, 31, 0.7) 50%, rgba(26, 26, 26, 0.4) 100%);
    }

    .tool-hero-content {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 10px;
      animation: heroFadeUp 0.45s ease-out;
    }

    @keyframes heroFadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .breadcrumb {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--dark-gray);
      margin-bottom: 10px;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .breadcrumb a {
      color: var(--text-medium);
      text-decoration: none !important;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: color 0.2s ease;
    }

    .breadcrumb a:hover { color: var(--accent-purple-dark); }
    .breadcrumb i { color: var(--dark-gray); opacity: 0.8; }
    .breadcrumb .current { color: var(--text-dark); font-weight: 600; }

    .save-btn {
      position: absolute;
      top: 16px;
      right: 24px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.6);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--accent-purple-dark);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .save-btn i { font-size: 13px; }

    .save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(123, 95, 196, 0.18);
      background: #ffffff;
    }

    .dark-mode .save-btn {
      background: rgba(20, 20, 20, 0.9);
      border-color: rgba(157, 134, 233, 0.6);
      color: var(--accent-purple);
    }

    .save-btn.saved {
      background: var(--accent-purple);
      color: #ffffff;
      border-color: transparent;
    }

    .checklist-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-purple);
      text-transform: uppercase;
      letter-spacing: 1.8px;
      margin-bottom: 14px;
      margin-top: 32px;
      display: block;
    }

    .hero-main-heading {
      font-size: 46px;
      font-weight: 600;
      color: var(--text-dark);
      line-height: 1.1;
      margin-bottom: 20px;
      max-width: 1100px;
    }

    .hero-subheading {
      font-size: 16px;
      color: var(--text-medium);
      line-height: 1.6;
      max-width: 980px;
      margin-bottom: 30px;
    }

    /* ===========================
       CATEGORY PILLS (Canonical colours)
    =========================== */
    .category-pills-container { margin-bottom: 30px; }

    .category-pills-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
      display: block;
    }

    .category-pills-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .category-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid transparent;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-decoration: none;
      height: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }

    .dark-mode .category-pill { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }

    .category-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      text-decoration: none;
    }

    .dark-mode .category-pill:hover { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35); }

    .category-pill.expectations {
      color: var(--category-clarity);
      border-color: rgba(123, 95, 196, 0.20);
      background: linear-gradient(135deg, rgba(123, 95, 196, 0.08), rgba(123, 95, 196, 0.04));
    }

    .dark-mode .category-pill.expectations {
      color: #9d86e9;
      border-color: rgba(157, 134, 233, 0.30);
      background: linear-gradient(135deg, rgba(123, 95, 196, 0.18), rgba(123, 95, 196, 0.10));
    }

    .category-icon { font-size: 11px; opacity: 0.85; flex-shrink: 0; }

    /* ===========================
       CONTEXT & PRO TIPS SECTION
    =========================== */
    .context-tips-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 40px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto 50px;
      padding: 24px 20px 10px;
      margin-top: 6px;
    }

    .context-card, .tips-card {
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 28px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .dark-mode .context-card,
    .dark-mode .tips-card { box-shadow: 0 2px 8px rgba(0,0,0,0.22); }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .section-title i { color: var(--accent-purple); }

    .bullet-list { list-style: none; margin: 0; padding: 0; }

    .bullet-list li {
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
      padding-left: 26px;
      position: relative;
    }

    .bullet-list li::before {
      content: "•";
      position: absolute;
      left: 10px;
      color: var(--accent-purple);
      font-size: 18px;
    }

    /* ===========================
       CHECKLIST BODY
    =========================== */
    .checklist-body {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 20px;
    }

    .checklist-section-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 18px;
      margin-top: 60px !important;
    }

    .checklist-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .checklist-item {
      background: var(--primary-white);
      padding: 14px 16px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      height: 100%;
      min-height: 70px;
    }

    .dark-mode .checklist-item { box-shadow: 0 1px 4px rgba(0,0,0,0.14); }

    .checklist-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .dark-mode .checklist-item:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.28); }

    .checklist-item i {
      color: var(--accent-purple);
      font-size: 18px;
      margin-top: 3px;
      flex-shrink: 0;
    }

    .checklist-text {
      flex: 1;
      color: var(--text-medium);
      font-size: 15px;
      line-height: 1.5;
    }

    /* ===========================
       CAPACITY METER SECTION
    =========================== */
    .capacity-meter-section {
      max-width: 1100px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .capacity-header { margin-bottom: 18px; text-align: left; }

    .capacity-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }

    .capacity-header p {
      font-size: 14px;
      color: var(--text-medium);
      max-width: 1100px;
      line-height: 1.5;
    }

    .capacity-meter-container {
      display: flex;
      align-items: stretch;
      gap: 30px;
      background: var(--primary-white);
      border-radius: 16px;
      padding: 22px 24px 20px;
      box-shadow: 0 8px 30px rgba(123, 95, 196, 0.12);
      border: 1px solid rgba(123, 95, 196, 0.15);
    }

    .dark-mode .capacity-meter-container {
      box-shadow: 0 8px 30px rgba(123, 95, 196, 0.25);
      border: 1px solid rgba(123, 95, 196, 0.35);
    }

    .capacity-progress-container { flex: 1.4; }

    .capacity-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .capacity-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-purple-dark);
    }

    /* requested: font 15, weight 500 */
    .capacity-status {
      font-size: 15px;
      font-weight: 500;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .status-green {
      background-color: rgba(16, 185, 129, 0.1);
      color: var(--capacity-green);
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-yellow {
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--capacity-yellow);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-red {
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--capacity-red);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .capacity-meter {
      height: 10px;
      background: var(--light-gray);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 6px;
      position: relative;
    }

    .dark-mode .capacity-meter { background: rgba(255, 255, 255, 0.12); }

    .meter-fill {
      height: 100%;
      width: 0%;
      border-radius: 5px;
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .meter-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .meter-yellow { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .meter-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

    .meter-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--dark-gray);
      gap: 10px;
    }

    .capacity-dimensions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .capacity-dimension-pill {
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      background: var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-medium);
    }

    .dark-mode .capacity-dimension-pill {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.1);
    }

    .capacity-dimension-pill span.label { font-weight: 600; color: var(--text-dark); }
    .capacity-dimension-pill span.score { font-weight: 700; color: var(--accent-purple); }

    .actions-container {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      max-width: 280px;
    }

    .action-btn {
      background: var(--premium-gradient);
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 13.5px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }

    .action-btn i { font-size: 14px; }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(123, 95, 196, 0.3);
    }

    .dark-mode .action-btn:hover { box-shadow: 0 8px 20px rgba(123, 95, 196, 0.4); }

    .action-btn.secondary {
      background: var(--light-purple);
      color: var(--accent-purple-dark);
      border: 1px solid rgba(123, 95, 196, 0.2);
    }

    .dark-mode .action-btn.secondary {
      background: rgba(123, 95, 196, 0.21);
      color: var(--accent-purple);
      border-color: rgba(157, 134, 233, 0.22);
    }

    .action-btn.secondary:hover { background: var(--accent-purple); color: white; }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* Tiny status line under Save Progress (premium but minimal) */
    .save-progress-status {
      font-size: 12px;
      color: var(--dark-gray);
      text-align: center;
      margin-top: -6px;
      min-height: 18px;
    }

    /* ===========================
       EVIDENCE SECTION
    =========================== */
    .evidence-section {
      max-width: 1100px;
      margin: 0 auto 60px;
      padding: 0 20px;
      display: none;
    }

    .evidence-section.active {
      display: block;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evidence-header { text-align: center; margin-bottom: 28px; }

    .evidence-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }

    .evidence-subtitle { color: var(--text-medium); font-size: 16px; margin-bottom: 8px; }

    .evidence-insight {
      font-size: 14px;
      color: var(--dark-gray);
      max-width: 680px;
      margin: 0 auto;
    }

    .section-header {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-gray);
    }

    .section-header.red { color: var(--danger-red); }
    .section-header.purple { color: var(--accent-purple-dark); }
    .section-header.blue { color: var(--accent-purple); }

    .evidence-facts-grid,
    .conversation-grid,
    .boundary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .evidence-card,
    .conversation-card,
    .boundary-card {
      background: var(--primary-white);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .evidence-card { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.1); }
    .conversation-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08); border: 1px solid rgba(123, 95, 196, 0.1); }
    .boundary-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08); border: 1px solid rgba(123, 95, 196, 0.1); transition: all 0.2s ease; }

    .dark-mode .evidence-card { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.18); border: 1px solid rgba(16, 185, 129, 0.22); }
    .dark-mode .conversation-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.21); border: 1px solid rgba(123, 95, 196, 0.25); }
    .dark-mode .boundary-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.21); border: 1px solid rgba(123, 95, 196, 0.25); }

    .boundary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(123, 95, 196, 0.16);
    }
    .dark-mode .boundary-card:hover { box-shadow: 0 8px 20px rgba(123, 95, 196, 0.25); }

    .evidence-card::before,
    .conversation-card::before,
    .boundary-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
    }

    .evidence-icon, .conversation-icon, .boundary-icon {
      font-size: 20px;
      color: var(--accent-purple);
      margin-bottom: 15px;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .evidence-icon { background: rgba(16, 185, 129, 0.1); }
    .conversation-icon, .boundary-icon { background: var(--lighter-purple); }

    .dark-mode .evidence-icon { background: rgba(16, 185, 129, 0.2); }
    .dark-mode .conversation-icon, .dark-mode .boundary-icon { background: rgba(123, 95, 196, 0.21); }

    .evidence-title-text, .conversation-title, .boundary-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .evidence-description, .conversation-description, .boundary-description {
      color: var(--text-medium);
      font-size: 14px;
      line-height: 1.5;
      flex-grow: 1;
    }

    .boundary-description { margin-bottom: 15px; }

    .boundary-link {
      color: var(--accent-purple);
      font-weight: 700;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: auto;
    }

    .boundary-link:hover { text-decoration: underline; }

    /* ===========================
       MY PLAYBOOK FAB + SIDEBAR
    =========================== */
    .my-playbook-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1200;
      background: var(--premium-gradient);
      color: #ffffff;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      transition: all 0.25s ease;
    }

    .my-playbook-fab i { font-size: 15px; }

    .my-playbook-fab:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.32);
    }

    .playbook-sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1190;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .playbook-sidebar-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .playbook-sidebar {
      position: fixed;
      top: 0;
      right: -380px;
      width: 340px;
      max-width: 90%;
      height: 100%;
      background: rgba(255, 255, 255, 0.94);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: -4px 0 20px rgba(0,0,0,0.25);
      z-index: 1191;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-light);
      transition: right 0.25s ease;
    }

    .dark-mode .playbook-sidebar {
      background: rgba(18, 18, 18, 0.96);
      box-shadow: -4px 0 22px rgba(0,0,0,0.6);
    }

    .playbook-sidebar.open { right: 0; }

    .playbook-sidebar-header {
      padding: 20px 20px 14px;
      border-bottom: 1px solid var(--border-light);
    }

    .playbook-sidebar-header-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .playbook-sidebar-header h3 {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-dark);
    }

    .playbook-sidebar-header p {
      font-size: 13px;
      color: var(--dark-gray);
    }

    .playbook-close-btn {
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 18px;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .playbook-close-btn:hover { background: var(--light-gray); }

    .playbook-sidebar-body {
      padding: 14px 18px 20px;
      padding-bottom: 50px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .saved-items-empty {
      font-size: 13px;
      color: var(--dark-gray);
      line-height: 1.6;
    }

    .saved-items-list { list-style: none; margin: 0; padding: 0; }

    .saved-item {
      padding: 10px 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: var(--primary-white);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .saved-item-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .saved-item-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-dark);
    }

    .saved-item-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--accent-purple-dark);
      font-weight: 800;
    }

    .saved-item-meta {
      font-size: 12px;
      color: var(--dark-gray);
    }

    .saved-item-link {
      margin-top: 6px;
      font-size: 12px;
      color: var(--accent-purple);
      text-decoration: none;
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .saved-item-link:hover { text-decoration: underline; }

    .playbook-quick-links {
      margin-top: 223px;
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
    }

    .quick-links-title {
      font-size: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-medium);
    }

    .playbook-quick-links-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .quick-link-pill {
      width: 50%;
      padding: 4px 4px;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.35);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.08),rgba(123, 95, 196, 0.02));
      text-decoration: none;
      color: var(--accent-purple-dark);
      font-size: 13px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-link-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.16), rgba(123, 95, 196, 0.06));
    }

    .quick-link-pill i { font-size: 14px; }

    .dark-mode .quick-link-pill {
      border-color: rgba(157, 134, 233, 0.55);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.26),rgba(123, 95, 196, 0.12));
    }

    /* ===========================
       FOOTER
    =========================== */
    footer {
      background: var(--primary-white);
      padding: 10px 0;
      border-top: 1px solid var(--border-light);
      margin-top: 30px;
      text-align: center;
      color: var(--text-medium);
    }

    /* ===========================
       AUTH LOCK (tool gated behind sign-in)
    =========================== */
    .auth-lock-overlay {
      position: fixed;
      inset: 0;
      z-index: 1300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    .auth-lock-overlay.active { display: flex; }

    .auth-lock-card {
      width: min(560px, 100%);
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 22px 22px 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }

    .dark-mode .auth-lock-card {
      background: rgba(18,18,18,0.96);
      border-color: rgba(255,255,255,0.10);
    }

    .auth-lock-title {
      font-size: 18px;
      font-weight: 900;
      color: var(--text-dark);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auth-lock-title i { color: var(--accent-purple); }

    .auth-lock-text {
      font-size: 14px;
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
    }

    .auth-lock-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auth-lock-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: 13px;
      text-decoration: none;
      white-space: nowrap;
    }

    .auth-lock-btn.primary { background: var(--premium-gradient); color: #fff; }
    .auth-lock-btn.secondary { background: var(--light-purple); color: var(--accent-purple-dark); }

    .dark-mode .auth-lock-btn.secondary {
      background: rgba(123, 95, 196, 0.21);
      color: var(--accent-purple);
    }

    /* Blur + disable tool area while locked */
    body.auth-locked .tool-hero-section,
    body.auth-locked .context-tips-grid,
    body.auth-locked .checklist-body,
    body.auth-locked .capacity-meter-section,
    body.auth-locked #evidenceSummary,
    body.auth-locked footer,
    body.auth-locked .my-playbook-fab {
      filter: blur(2px);
      opacity: 0.55;
      pointer-events: none;
      user-select: none;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .context-tips-grid { grid-template-columns: 1fr; gap: 24px; }
      .evidence-facts-grid, .conversation-grid, .boundary-grid { grid-template-columns: repeat(2, 1fr); }
      .checklist-grid { grid-template-columns: 1fr; }
      .checklist-section-title { margin-top: 50px !important; }
      .capacity-meter-container { flex-direction: column; }
      .actions-container { max-width: 100%; flex-direction: row; flex-wrap: wrap; }
    }

    @media (max-width: 768px) {
      .tool-hero-section { margin-top: 100px; }
      .context-tips-grid { padding: 20px 20px 10px; margin-top: 5px; }
      .context-card, .tips-card { padding: 24px; }
      .section-title { font-size: 18px; white-space: normal; }
      .hero-main-heading { font-size: 36px; }
      .hero-subheading { font-size: 16px; max-width: 100%; }
      .capacity-meter-container { padding: 18px 18px 18px; }
      .actions-container { flex-direction: column; align-items: stretch; }
      .evidence-facts-grid, .conversation-grid, .boundary-grid { grid-template-columns: 1fr; }
      .category-pills-grid { justify-content: flex-start; }
      .checklist-section-title { margin-top: 40px !important; }
      .save-btn { right: 18px; top: 10px; }
      .my-playbook-fab { bottom: 18px; right: 18px; }
    }

    @media (max-width: 480px) {
      .hero-main-heading { font-size: 32px; }
      .checklist-name { font-size: 18px; }
      .evidence-title { font-size: 22px; }
      .section-header { font-size: 18px; }
      .capacity-status { font-size: 14px; }
      .category-pill { font-size: 11px; padding: 5px 10px; height: 30px; }
      .checklist-item { padding: 12px 14px; min-height: 65px; }
      .checklist-text { font-size: 14px; }
      .checklist-section-title { margin-top: 30px !important; }
      .capacity-dimensions { grid-template-columns: 1fr; }
    }
  </style>
</head>

<!-- Start locked to prevent “flash” of usable UI before auth resolves -->
<body class="auth-locked">

  <!-- Mobile My Playbook tab -->
  <a href="#" class="mobile-cta-tab" id="mobileMyPlaybookTab">My Playbook</a>

  <!-- ===========================
       NAVIGATION (POST-LOGIN)
  =========================== -->
  <nav>
    <div class="container nav-container">
      <button class="mobile-toggle" aria-label="Open menu"><i class="fas fa-bars"></i></button>

      <a href="index.html" class="logo" aria-label="Home">
        <img src="assets/img/logo.png" alt="The Employee Playbook" class="logo-img" id="mainLogo"
             onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
        <div class="logo-fallback" id="logo-fallback">THE EMPLOYEE PLAYBOOK</div>
      </a>

      <div class="nav-links">
        <a href="the-lens.html" class="nav-link">The Lens</a>
        <a href="the-toolkit.html" class="nav-link active">The Toolkit</a>
        <div class="nav-link-container">
          <a href="the-coach.html" class="nav-link">The Coach</a>
          <span class="new-tag">NEW</span>
        </div>
        <a href="the-shift.html" class="nav-link">The Shift</a>
        <a href="the-pricing.html" class="nav-link">The Pricing</a>

        <a href="profile.html" class="mobile-profile" id="mobileProfileBtn">Profile</a>
      </div>

      <div class="nav-actions">
        <a href="sign-in.html" class="user-initials" id="userInitialsBtn" aria-label="Open profile">…</a>
        <span class="plan-pill" id="userPlanPill">Free</span>
        <a class="logout-link" id="logoutBtn" href="#" aria-label="Log out">Log out</a>
        <button class="theme-toggle" id="themeToggleBtn" aria-label="Toggle theme"><i class="fas fa-moon"></i></button>
      </div>
    </div>
  </nav>

  <!-- ===========================
       HERO
  =========================== -->
  <div class="tool-hero-section">
    <button class="save-btn" id="saveBtn">
      <i class="far fa-bookmark"></i>
      <span>Save Item</span>
    </button>

    <div class="tool-hero-content">
      <div class="breadcrumb">
        <a href="the-toolkit.html">Toolkit</a>
        <i class="fas fa-chevron-right"></i>
        <span>Expectation, Burnout &amp; Capacity</span>
        <i class="fas fa-chevron-right"></i>
        <span class="current">Capacity Checklist</span>
      </div>

      <span class="checklist-name">CAPACITY CHECKLIST</span>

      <h1 class="hero-main-heading">Facts Over Feelings → Workload Evidence</h1>

      <div class="hero-subheading">
        When you're overwhelmed or feel at capacity, use this tool to move from subjective feelings to objective evidence.
        Collect concrete data about your actual workload to have better conversations about priorities, deadlines, and what’s truly possible.
      </div>

      <div class="category-pills-container">
        <span class="category-pills-title">Category</span>

        <div class="category-pills-grid">
          <a href="category-clarity-priorities-and-direction.html" class="category-pill expectations">
            <i class="fas fa-bullseye category-icon"></i>
            <span>Clarity, Priorities &amp; Direction</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- ===========================
       CONTEXT & PRO TIPS
  =========================== -->
  <div class="context-tips-grid">
    <div class="context-card">
      <h3 class="section-title"><i class="fas fa-calendar-check"></i>When to Use This Checklist</h3>
      <ul class="bullet-list">
        <li>When you feel constantly overwhelmed or at capacity</li>
        <li>Before having a conversation with your manager about workload</li>
        <li>When you're being asked to take on additional responsibilities</li>
        <li>When you need to push back on unrealistic deadlines or expectations</li>
        <li>When you suspect your actual workload doesn't match your role or level</li>
        <li>When planning for the next quarter or performance review</li>
      </ul>
    </div>

    <div class="tips-card">
      <h3 class="section-title"><i class="fas fa-lightbulb"></i>Pro Tips</h3>
      <ul class="bullet-list">
        <li>Track your actual time for 1–2 weeks for the most accurate data</li>
        <li>Include meetings, email, and “invisible work” in your calculations</li>
        <li>Be specific with your evidence — numbers are more persuasive than feelings</li>
        <li>Use this as a collaborative tool, not a weapon against your manager</li>
        <li>Focus on solutions, not just problems — bring options to the conversation</li>
        <li>Update this regularly as your role and responsibilities evolve</li>
      </ul>
    </div>
  </div>

  <!-- ===========================
       CHECKLIST BODY
  =========================== -->
  <div class="checklist-body" id="checklistText">
    <h2 class="checklist-section-title">Your Capacity Checklist</h2>

    <div class="checklist-grid">
      <div class="checklist-item" data-category="tracking">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've tracked my actual time spent on different types of work for at least one full week.</div>
      </div>
      <div class="checklist-item" data-category="hours">
        <i class="far fa-square"></i>
        <div class="checklist-text">I know how many hours I'm actually working each week (not just “feels like” a lot).</div>
      </div>
      <div class="checklist-item" data-category="meetings">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've calculated what percentage of my week is spent in meetings versus focused work.</div>
      </div>
      <div class="checklist-item" data-category="invisible">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've accounted for “invisible work” — emails, quick questions, administrative tasks, context switching.</div>
      </div>
      <div class="checklist-item" data-category="scope">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've documented all my current responsibilities and projects with estimated time requirements.</div>
      </div>
      <div class="checklist-item" data-category="comparison">
        <i class="far fa-square"></i>
        <div class="checklist-text">I can compare my current workload to my job description or role expectations.</div>
      </div>
      <div class="checklist-item" data-category="sustainability">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've assessed whether my current workload is sustainable long-term without burnout.</div>
      </div>
      <div class="checklist-item" data-category="growth">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've identified what percentage of my time is spent on growth vs maintenance work.</div>
      </div>
      <div class="checklist-item" data-category="priority-time">
        <i class="far fa-square"></i>
        <div class="checklist-text">I know how much time I actually have for priority work versus reactive work.</div>
      </div>
      <div class="checklist-item" data-category="buffer">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've calculated what buffer I have for unexpected work or emergencies.</div>
      </div>
      <div class="checklist-item" data-category="data-visual">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've created a visual (chart, graph, or simple summary) of my workload distribution.</div>
      </div>
      <div class="checklist-item" data-category="options">
        <i class="far fa-square"></i>
        <div class="checklist-text">I've identified what could be deprioritised, delegated, or done differently to create capacity.</div>
      </div>
    </div>
  </div>

  <!-- ===========================
       CAPACITY METER SECTION
  =========================== -->
  <div class="capacity-meter-section">
    <div class="capacity-header">
      <h2>Your Capacity Scorer</h2>
      <p>
        Your Capacity Score shows how well you understand your actual workload versus perceived workload.
        High scores mean you have strong evidence about your capacity; low scores indicate you're operating
        on feelings rather than facts. Use this to build evidence for workload conversations.
      </p>
    </div>

    <div class="capacity-meter-container">
      <div class="capacity-progress-container">
        <div class="capacity-title-row">
          <div class="capacity-title">Capacity Evidence Score</div>
          <div class="capacity-status" id="capacityStatus">Gathering Data</div>
        </div>

        <div class="capacity-meter">
          <div class="meter-fill" id="meterFill"></div>
        </div>

        <div class="meter-labels">
          <span>Operating on Feelings</span>
          <span>Some Evidence</span>
          <span>Strong Evidence Base</span>
        </div>

        <div class="capacity-dimensions">
          <div class="capacity-dimension-pill">
            <span class="label">Time Tracking</span>
            <span class="score" id="scoreTracking">0%</span>
          </div>
          <div class="capacity-dimension-pill">
            <span class="label">Workload Analysis</span>
            <span class="score" id="scoreAnalysis">0%</span>
          </div>
          <div class="capacity-dimension-pill">
            <span class="label">Evidence Quality</span>
            <span class="score" id="scoreEvidence">0%</span>
          </div>
          <div class="capacity-dimension-pill">
            <span class="label">Solution Thinking</span>
            <span class="score" id="scoreSolutions">0%</span>
          </div>
        </div>
      </div>

      <div class="actions-container">
        <button class="action-btn" onclick="generateEvidenceSummary()" id="generateBtn" disabled>
          <i class="fas fa-chart-bar"></i> Generate Evidence Report
        </button>

        <button class="action-btn secondary" onclick="copyChecklist()" id="copyBtn">
          <i class="far fa-copy"></i> Copy Checklist
        </button>

        <button class="action-btn secondary" onclick="printChecklistPDF()" id="printBtn">
          <i class="fas fa-print"></i> Print / Save PDF
        </button>

        <button class="action-btn secondary" onclick="clearAllChecklist()" id="clearBtn" disabled>
          <i class="fas fa-eraser"></i> Clear All
        </button>

        <!-- ✅ Cloud save: MANUAL ONLY -->
        <button class="action-btn secondary" id="saveProgressBtn" disabled>
          <i class="fas fa-cloud-arrow-up"></i> Save Progress
        </button>
        <div class="save-progress-status" id="saveProgressStatus"></div>
      </div>
    </div>
  </div>

  <!-- ===========================
       EVIDENCE SECTION
  =========================== -->
  <div class="evidence-section" id="evidenceSummary">
    <div class="evidence-header">
      <h2 class="evidence-title">Your Workload Evidence Report</h2>
      <p class="evidence-subtitle">
        Based on your Capacity Evidence Score of <span id="summaryScore">0%</span> • Status: <span id="summaryStatus">Gathering Data</span>
      </p>
      <p class="evidence-insight">
        This report transforms feelings into facts. Use it to have evidence-based conversations about workload,
        priorities, and realistic expectations.
      </p>
    </div>

    <h3 class="section-header purple">
      <i class="fas fa-chart-pie"></i> Key Workload Evidence
    </h3>
    <div class="evidence-facts-grid" id="evidenceFactsGrid"></div>

    <h3 class="section-header blue">
      <i class="fas fa-comments"></i> Conversation Starters
    </h3>
    <div class="conversation-grid" id="conversationGrid"></div>

    <h3 class="section-header purple">
      <i class="fas fa-tools"></i> Capacity Building Strategies
    </h3>
    <div class="boundary-grid" id="boundaryGrid"></div>
  </div>

  <!-- ===========================
       MY PLAYBOOK SIDEBAR
  =========================== -->
  <div class="playbook-sidebar-overlay" id="playbookOverlay">
    <div class="playbook-sidebar" id="playbookSidebar">
      <div class="playbook-sidebar-header">
        <div class="playbook-sidebar-header-title-row">
          <h3>My Playbook</h3>
          <button class="playbook-close-btn" id="closePlaybook" aria-label="Close My Playbook">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <p>Saved items</p>
      </div>

      <div class="playbook-sidebar-body">
        <div id="savedItemsContainer">
          <p class="saved-items-empty" id="savedItemsEmpty">
            You haven't saved anything yet. Use <strong>Save Item</strong> on tools you want quick access to.
          </p>
          <ul class="saved-items-list" id="savedItemsList"></ul>
        </div>

        <div class="playbook-quick-links">
          <div class="playbook-quick-links-header">
            <span class="quick-links-title">Quick links</span>
          </div>
          <div class="playbook-quick-links-list">
            <a href="dashboard.html" class="quick-link-pill">
              <i class="fas fa-gauge"></i> The Dashboard
            </a>
            <a href="the-lens.html" class="quick-link-pill">
              <i class="fas fa-search"></i> The Lens
            </a>
            <a href="the-toolkit.html" class="quick-link-pill">
              <i class="fas fa-toolbox"></i> The Toolkit
            </a>
            <a href="the-coach.html" class="quick-link-pill">
              <i class="fas fa-comments"></i> The Coach
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating My Playbook button -->
  <div class="my-playbook-fab" id="myPlaybookButton">
    <i class="fas fa-book-open"></i>
    <span>My Playbook</span>
  </div>

  <!-- ===========================
       FOOTER
  =========================== -->
  <footer>
    <div class="container">
      <p>© 2025 The Employee Playbook. All rights reserved.</p>
    </div>
  </footer>

  <!-- ===========================
       AUTH LOCK OVERLAY (gates tool behind sign-in)
  =========================== -->
  <div class="auth-lock-overlay active" id="authLockOverlay" aria-hidden="false">
    <div class="auth-lock-card" role="dialog" aria-modal="true" aria-label="Sign in required">
      <div class="auth-lock-title">
        <i class="fas fa-lock"></i>
        Sign in required
      </div>
      <div class="auth-lock-text">
        This tool is available to members only. Please sign in. 
      </div>
      <div class="auth-lock-actions">
        <a class="auth-lock-btn primary" href="sign-in.html">
          <i class="fas fa-right-to-bracket"></i> Sign in
        </a>
        <a class="auth-lock-btn secondary" href="the-pricing.html">
          <i class="fas fa-gem"></i> View plans
        </a>
      </div>
    </div>
  </div>

  <!-- ===========================
       JAVASCRIPT (page logic)
  =========================== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');

      // Apply preload theme properly to body
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.body.classList.add('dark-mode');
        document.documentElement.classList.remove('preload-dark');
      } catch (e) {}

      initializeChecklist();
      initializeThemeToggle();
      initializeMobileNav();
      initializePlaybook();
      wireHeaderMyPlaybookHooks();
    });

    /* ===========================
       MOBILE NAV
    =========================== */
    function initializeMobileNav() {
      const mobileToggle = document.querySelector('.mobile-toggle');
      const navLinks = document.querySelector('.nav-links');

      if (mobileToggle && navLinks) {
        mobileToggle.addEventListener('click', function () {
          navLinks.classList.toggle('active');
          const icon = this.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
          }
        });
      }

      document.addEventListener('click', function(event) {
        if (!navLinks || !mobileToggle) return;
        if (navLinks.classList.contains('active') &&
            !navLinks.contains(event.target) &&
            !mobileToggle.contains(event.target)) {
          navLinks.classList.remove('active');
          const icon = mobileToggle.querySelector('i');
          if (icon) {
            icon.classList.add('fa-bars');
            icon.classList.remove('fa-times');
          }
        }
      });
    }

    /* ===========================
       THEME TOGGLE (stable)
    =========================== */
    function initializeThemeToggle() {
      const themeToggleBtn = document.getElementById('themeToggleBtn');
      if (!themeToggleBtn) return;

      const themeIcon = themeToggleBtn.querySelector('i');
      const logoImg = document.getElementById('mainLogo');

      function updateIcon(isDark) {
        if (!themeIcon) return;
        themeIcon.classList.toggle('fa-moon', !isDark);
        themeIcon.classList.toggle('fa-sun', isDark);
      }

      function updateLogo(isDark) {
        if (!logoImg) return;
        logoImg.src = isDark ? 'assets/img/logo-dark.png' : 'assets/img/logo.png';
      }

      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDarkInitial = saved ? saved === 'dark' : prefersDark;
      updateIcon(isDarkInitial);
      updateLogo(isDarkInitial);

      themeToggleBtn.addEventListener('click', function() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateIcon(isDarkMode);
        updateLogo(isDarkMode);
      });

      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', (e) => {
        if (localStorage.getItem('theme')) return;
        const shouldDark = e.matches;
        document.body.classList.toggle('dark-mode', shouldDark);
        updateIcon(shouldDark);
        updateLogo(shouldDark);
      });

      if (logoImg) {
        logoImg.addEventListener('error', function() {
          if (this.src.includes('logo-dark.png')) {
            this.src = 'assets/img/logo.png';
          } else {
            this.style.display = 'none';
            const fb = document.getElementById('logo-fallback');
            if (fb) fb.style.display = 'block';
          }
        });
      }
    }

    /* ===========================
       CHECKLIST LOGIC (state on window)
    =========================== */
    window.checkedItems = [];
    window.itemCategories = [];

    const dimensionConfig = {
      tracking: ['tracking', 'hours', 'meetings'],
      analysis: ['invisible', 'scope', 'comparison', 'sustainability'],
      evidence: ['growth', 'priority-time', 'buffer', 'data-visual'],
      solutions: ['options']
    };

    function setIconChecked(iconEl, checked) {
      if (!iconEl) return;
      if (checked) {
        iconEl.classList.remove('fa-square', 'far');
        iconEl.classList.add('fa-check-square', 'fas');
        iconEl.style.color = '#5A4496';
      } else {
        iconEl.classList.remove('fa-check-square', 'fas');
        iconEl.classList.add('fa-square', 'far');
        iconEl.style.color = '#7B5FC4';
      }
    }

    function initializeChecklist() {
      const checklistContainers = document.querySelectorAll('.checklist-item');
      window.checkedItems = new Array(checklistContainers.length).fill(false);
      window.itemCategories = [];

      checklistContainers.forEach((container, index) => {
        const icon = container.querySelector('i');
        const category = container.getAttribute('data-category');
        window.itemCategories[index] = category;

        container.addEventListener('click', function(e) {
          if (document.body.classList.contains('auth-locked')) return; // extra hard stop
          if (e.target.tagName === 'BUTTON') return;

          const isChecked = icon?.classList.contains('fa-check-square');
          const next = !isChecked;

          window.checkedItems[index] = next;
          setIconChecked(icon, next);

          updateCapacityScore();
        });
      });

      updateCapacityScore();
    }

    function updateCapacityScore() {
      const checkedCount = window.checkedItems.filter(Boolean).length;
      const totalCount = window.checkedItems.length;
      const capacityScore = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

      const meterFill = document.getElementById('meterFill');
      const capacityStatus = document.getElementById('capacityStatus');

      if (meterFill) meterFill.style.width = capacityScore + '%';

      if (meterFill) meterFill.classList.remove('meter-green', 'meter-yellow', 'meter-red');
      if (capacityStatus) capacityStatus.classList.remove('status-green', 'status-yellow', 'status-red');

      let statusText = 'Gathering Data';
      if (capacityScore >= 75) {
        if (meterFill) meterFill.classList.add('meter-green');
        if (capacityStatus) capacityStatus.classList.add('status-green');
        statusText = 'Strong Evidence';
      } else if (capacityScore >= 40) {
        if (meterFill) meterFill.classList.add('meter-yellow');
        if (capacityStatus) capacityStatus.classList.add('status-yellow');
        statusText = 'Moderate Evidence';
      } else {
        if (meterFill) meterFill.classList.add('meter-red');
        if (capacityStatus) capacityStatus.classList.add('status-red');
        statusText = 'Gathering Data';
      }
      if (capacityStatus) capacityStatus.textContent = statusText;

      const generateBtn = document.getElementById('generateBtn');
      const clearBtn = document.getElementById('clearBtn');
      if (generateBtn) generateBtn.disabled = checkedCount === 0;
      if (clearBtn) clearBtn.disabled = checkedCount === 0;

      const dimensionScores = {
        tracking: { checked: 0, total: 0 },
        analysis: { checked: 0, total: 0 },
        evidence: { checked: 0, total: 0 },
        solutions: { checked: 0, total: 0 }
      };

      window.itemCategories.forEach((category, index) => {
        Object.keys(dimensionConfig).forEach(dim => {
          if (dimensionConfig[dim].includes(category)) {
            dimensionScores[dim].total += 1;
            if (window.checkedItems[index]) dimensionScores[dim].checked += 1;
          }
        });
      });

      const trackingScore = dimensionScores.tracking.total ? Math.round((dimensionScores.tracking.checked / dimensionScores.tracking.total) * 100) : 0;
      const analysisScore  = dimensionScores.analysis.total ? Math.round((dimensionScores.analysis.checked  / dimensionScores.analysis.total)  * 100) : 0;
      const evidenceScore  = dimensionScores.evidence.total ? Math.round((dimensionScores.evidence.checked  / dimensionScores.evidence.total)  * 100) : 0;
      const solutionsScore = dimensionScores.solutions.total ? Math.round((dimensionScores.solutions.checked / dimensionScores.solutions.total) * 100) : 0;

      const st = document.getElementById('scoreTracking');
      const sa = document.getElementById('scoreAnalysis');
      const se = document.getElementById('scoreEvidence');
      const ss = document.getElementById('scoreSolutions');

      if (st) st.textContent = trackingScore + '%';
      if (sa) sa.textContent = analysisScore + '%';
      if (se) se.textContent = evidenceScore + '%';
      if (ss) ss.textContent = solutionsScore + '%';
    }

    // expose for module
    window.updateCapacityScore = updateCapacityScore;

    /* ===========================
       EVIDENCE SUMMARY
    =========================== */
    function generateEvidenceSummary() {
      if (document.body.classList.contains('auth-locked')) return;

      const checkedCount = window.checkedItems.filter(Boolean).length;
      const totalCount = window.checkedItems.length;
      const capacityScore = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

      document.getElementById('summaryScore').textContent = capacityScore + '%';

      let statusText = 'Gathering Data';
      if (capacityScore >= 75) statusText = 'Strong Evidence';
      else if (capacityScore >= 40) statusText = 'Moderate Evidence';
      document.getElementById('summaryStatus').textContent = statusText;

      document.getElementById('evidenceSummary').classList.add('active');
      document.getElementById('evidenceSummary').scrollIntoView({ behavior: 'smooth' });

      generateEvidenceFacts();
      generateConversationStarters(capacityScore);
      generateCapacityStrategies();
    }

    function generateEvidenceFacts() {
      const evidenceFactsGrid = document.getElementById('evidenceFactsGrid');
      if (!evidenceFactsGrid) return;
      evidenceFactsGrid.innerHTML = '';

      const evidenceFacts = [];

      if (window.checkedItems[0]) evidenceFacts.push({ title: 'Actual Time Data', description: 'You have concrete data on how you spend your time — the foundation for evidence-based conversations.', icon: 'fas fa-clock' });
      if (window.checkedItems[1]) evidenceFacts.push({ title: 'Real Hours Worked', description: 'You know your actual weekly hours, not just perceived load. This helps identify unsustainable patterns.', icon: 'fas fa-business-time' });
      if (window.checkedItems[2]) evidenceFacts.push({ title: 'Meeting vs Focus Balance', description: 'You understand your meeting-to-focus ratio — a key driver of capacity and output.', icon: 'fas fa-chart-pie' });
      if (window.checkedItems[3]) evidenceFacts.push({ title: 'Invisible Work Counted', description: 'You’ve accounted for the hidden work that quietly consumes time and attention.', icon: 'fas fa-eye-slash' });
      if (window.checkedItems[4]) evidenceFacts.push({ title: 'Documented Responsibilities', description: 'You have a clear list of responsibilities and time requirements — making scope visible.', icon: 'fas fa-list-check' });
      if (window.checkedItems[5]) evidenceFacts.push({ title: 'Role Alignment Check', description: 'You can compare actual load vs role expectations — highlighting mismatches early.', icon: 'fas fa-balance-scale' });

      const checkedCount = window.checkedItems.filter(Boolean).length;
      if (checkedCount >= 3 && evidenceFacts.length === 0) evidenceFacts.push({ title: 'Multiple Data Points', description: 'You have several workload data points, strengthening your evidence base.', icon: 'fas fa-database' });
      if (evidenceFacts.length === 0) evidenceFacts.push({ title: 'Start with One Week', description: 'Begin with a one-week audit. Evidence builds fast once you track consistently.', icon: 'fas fa-flag' });

      while (evidenceFacts.length < 3) {
        if (evidenceFacts.length === 1) evidenceFacts.push({ title: 'Workload Patterns', description: 'Tracking reveals patterns in where time leaks and where output actually happens.', icon: 'fas fa-chart-line' });
        else evidenceFacts.push({ title: 'Capacity Clarity', description: 'Evidence shows which work is essential and which work is accidental.', icon: 'fas fa-lightbulb' });
      }

      evidenceFacts.slice(0, 3).forEach((fact) => {
        const card = document.createElement('div');
        card.className = 'evidence-card';
        card.innerHTML = `
          <div class="evidence-icon"><i class="${fact.icon}"></i></div>
          <h4 class="evidence-title-text">${fact.title}</h4>
          <p class="evidence-description">${fact.description}</p>
        `;
        evidenceFactsGrid.appendChild(card);
      });
    }

    function generateConversationStarters(capacityScore) {
      const conversationGrid = document.getElementById('conversationGrid');
      if (!conversationGrid) return;
      conversationGrid.innerHTML = '';

      let starters = [];

      if (capacityScore >= 75) {
        starters = [
          { title: 'Prioritisation with proof', description: '"Based on my tracking, I’m spending X hours on Y. Can we confirm what stays top priority and what gets paused?"', icon: 'fas fa-chart-bar' },
          { title: 'Sustainable workload', description: '"My data shows I’m consistently at X hours. To keep output strong, can we reset expectations for what fits in a normal week?"', icon: 'fas fa-heartbeat' },
          { title: 'Meeting vs focus', description: '"Meetings are taking X% of my week. Can we agree which are essential and which can be reduced or replaced?"', icon: 'fas fa-users' }
        ];
      } else if (capacityScore >= 40) {
        starters = [
          { title: 'Initial workload review', description: '"I’ve started tracking and I’m seeing patterns. Can we review my responsibilities and priorities?"', icon: 'fas fa-clipboard-check' },
          { title: 'Scope & expectations', description: '"I want to make sure I’m delivering on the right things. Can we align on my top 3 priorities for this quarter?"', icon: 'fas fa-bullseye' },
          { title: 'Evidence plan', description: '"I’m going to track my time for a week so we can talk with facts. Can we schedule 15 minutes to review it?"', icon: 'fas fa-calendar-plus' }
        ];
      } else {
        starters = [
          { title: 'Start the conversation', description: '"I want to get clearer on my capacity. Can we discuss what’s on my plate and what ‘good’ looks like right now?"', icon: 'fas fa-comment' },
          { title: 'Reality check', description: '"I feel at capacity. Can we review deadlines and decide what can move, or what we can stop doing?"', icon: 'fas fa-tasks' },
          { title: 'One-week audit', description: '"I’m going to do a quick one-week audit of my time so we can see where the load is coming from."', icon: 'fas fa-stopwatch' }
        ];
      }

      starters.forEach((starter) => {
        const card = document.createElement('div');
        card.className = 'conversation-card';
        card.innerHTML = `
          <div class="conversation-icon"><i class="${starter.icon}"></i></div>
          <h4 class="conversation-title">${starter.title}</h4>
          <p class="conversation-description">${starter.description}</p>
        `;
        conversationGrid.appendChild(card);
      });
    }

    function generateCapacityStrategies() {
      const boundaryGrid = document.getElementById('boundaryGrid');
      if (!boundaryGrid) return;
      boundaryGrid.innerHTML = '';

      const uncheckedCategories = {};
      window.checkedItems.forEach((checked, index) => {
        if (!checked) {
          const category = window.itemCategories[index];
          uncheckedCategories[category] = (uncheckedCategories[category] || 0) + 1;
        }
      });

      const strategies = [];

      strategies.push({
        title: 'One-week time audit',
        description: 'Log all work for 7 days. Categorise by meetings, deep work, admin, reactive requests, and “invisible work”.',
        icon: 'fas fa-stopwatch'
      });

      if (uncheckedCategories['meetings']) {
        strategies.push({
          title: 'Meeting effectiveness review',
          description: 'Identify which meetings are essential, which can be reduced, and where you can be optional rather than required.',
          icon: 'fas fa-user-clock'
        });
      } else {
        strategies.push({
          title: 'Protected focus time',
          description: 'Block 2–3 protected hours for priority work. Keep it consistent so output stays predictable.',
          icon: 'fas fa-lock'
        });
      }

      if (uncheckedCategories['options']) {
        strategies.push({
          title: 'Deprioritise / delegate list',
          description: 'Write a short list: what can stop, what can reduce, what can delegate, what can automate. Take that list to your manager.',
          icon: 'fas fa-people-arrows'
        });
      } else {
        strategies.push({
          title: 'Quarterly load reset',
          description: 'Schedule a quarterly review of responsibilities to ensure expectations and workload remain realistic.',
          icon: 'fas fa-calendar-alt'
        });
      }

      strategies.slice(0, 3).forEach(strategy => {
        const card = document.createElement('div');
        card.className = 'boundary-card';
        card.innerHTML = `
          <div class="boundary-icon"><i class="${strategy.icon}"></i></div>
          <h4 class="boundary-title">${strategy.title}</h4>
          <p class="boundary-description">${strategy.description}</p>
          <a href="#" class="boundary-link" onclick="return false;">
            Learn More <i class="fas fa-arrow-right"></i>
          </a>
        `;
        boundaryGrid.appendChild(card);
      });
    }

    /* ===========================
       COPY CHECKLIST
    =========================== */
    function copyChecklist() {
      if (document.body.classList.contains('auth-locked')) return;

      const checklistName = 'CAPACITY CHECKLIST';
      const mainHeading = document.querySelector('.hero-main-heading')?.textContent || 'Capacity Checklist';
      const checklistItems = document.querySelectorAll('.checklist-text');

      let text = `${checklistName}\n`;
      text += `=============================\n\n`;
      text += `${mainHeading}\n\n`;
      text += `CAPACITY CHECKLIST:\n`;
      text += `===================\n\n`;

      checklistItems.forEach((item, index) => {
        const isChecked = window.checkedItems[index] ? '[✓]' : '[ ]';
        text += `${isChecked} ${index + 1}. ${item.innerText}\n`;
      });

      const checkedCount = window.checkedItems.filter(Boolean).length;
      if (checkedCount > 0) {
        const capacityScore = Math.round((checkedCount / checklistItems.length) * 100);
        let status = 'Gathering Data';
        if (capacityScore >= 75) status = 'Strong Evidence';
        else if (capacityScore >= 40) status = 'Moderate Evidence';

        text += `\nCURRENT STATUS:\n`;
        text += `===============\n`;
        text += `Items checked: ${checkedCount}/${checklistItems.length}\n`;
        text += `Capacity Evidence Score: ${capacityScore}%\n`;
        text += `Status: ${status}\n`;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
      }

      const btn = document.getElementById('copyBtn');
      if (!btn) return;

      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i> Checklist Copied!';
      btn.style.background = '#10b981';

      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.background = '';
      }, 2000);
    }

    /* ===========================
       PRINT / SAVE PDF
    =========================== */
    function printChecklistPDF() {
      if (document.body.classList.contains('auth-locked')) return;
      window.print();
    }

    /* ===========================
       CLEAR ALL
    =========================== */
    function clearAllChecklist() {
      if (document.body.classList.contains('auth-locked')) return;

      const items = document.querySelectorAll('.checklist-item');
      items.forEach((container, index) => {
        const icon = container.querySelector('i');
        window.checkedItems[index] = false;
        setIconChecked(icon, false);
      });

      const report = document.getElementById('evidenceSummary');
      if (report) report.classList.remove('active');

      updateCapacityScore();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /* ===========================
       MY PLAYBOOK (LOCALSTORAGE) ✅ Save Item bookmark
    =========================== */
    const PLAYBOOK_KEY = 'tepSavedItems';
    const CURRENT_TOOL_ID = 'capacity-checklist';
    const CURRENT_TOOL_TITLE = 'Capacity Checklist';
    const CURRENT_TOOL_TYPE = 'Item';

    function getSavedItems() {
      try {
        const raw = localStorage.getItem(PLAYBOOK_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        return [];
      }
    }

    function setSavedItems(items) {
      try { localStorage.setItem(PLAYBOOK_KEY, JSON.stringify(items)); }
      catch (e) {}
    }

    function openPlaybookUI() {
      const overlay = document.getElementById('playbookOverlay');
      const sidebar = document.getElementById('playbookSidebar');
      if (overlay && sidebar) {
        overlay.classList.add('open');
        sidebar.classList.add('open');
      }
    }

    function closePlaybookUI() {
      const overlay = document.getElementById('playbookOverlay');
      const sidebar = document.getElementById('playbookSidebar');
      if (overlay && sidebar) {
        overlay.classList.remove('open');
        sidebar.classList.remove('open');
      }
    }

    function wireHeaderMyPlaybookHooks() {
      const myPlaybookMobileTab = document.getElementById('mobileMyPlaybookTab');
      if (!myPlaybookMobileTab) return;

      myPlaybookMobileTab.addEventListener('click', (e) => {
        e.preventDefault();
        openPlaybookUI();

        const navLinks = document.querySelector('.nav-links');
        if (navLinks && navLinks.classList.contains('active')) {
          navLinks.classList.remove('active');
          const icon = document.querySelector('.mobile-toggle i');
          if (icon) {
            icon.classList.add('fa-bars');
            icon.classList.remove('fa-times');
          }
        }
      });
    }

    function initializePlaybook() {
      const playbookOverlay = document.getElementById('playbookOverlay');
      const playbookSidebar = document.getElementById('playbookSidebar');
      const playbookButton = document.getElementById('myPlaybookButton');
      const closeBtn = document.getElementById('closePlaybook');
      const saveItemBtn = document.getElementById('saveBtn');

      if (!playbookOverlay || !playbookSidebar || !playbookButton || !closeBtn || !saveItemBtn) return;

      renderSavedItems();

      const savedItems = getSavedItems();
      const isAlreadySaved = savedItems.some(item => item.id === CURRENT_TOOL_ID);
      updateSaveButtonState(saveItemBtn, isAlreadySaved);

      saveItemBtn.addEventListener('click', () => {
        // even though tool is locked for signed-out users, keep behaviour consistent:
        // if locked, do nothing (because you asked HARD lock).
        if (document.body.classList.contains('auth-locked')) return;

        const items = getSavedItems();
        const index = items.findIndex(item => item.id === CURRENT_TOOL_ID);
        let nowSaved;

        if (index === -1) {
          const toolLink = window.location.pathname.split('/').pop() || 'capacity-checklist.html';
          items.push({
            id: CURRENT_TOOL_ID,
            title: CURRENT_TOOL_TITLE,
            type: CURRENT_TOOL_TYPE,
            link: toolLink,
            savedAt: new Date().toISOString()
          });
          nowSaved = true;
        } else {
          items.splice(index, 1);
          nowSaved = false;
        }

        setSavedItems(items);
        updateSaveButtonState(saveItemBtn, nowSaved);
        renderSavedItems();
      });

      playbookButton.addEventListener('click', (e) => {
        e.preventDefault();
        openPlaybookUI();
      });
      closeBtn.addEventListener('click', closePlaybookUI);

      playbookOverlay.addEventListener('click', (e) => {
        if (e.target === playbookOverlay) closePlaybookUI();
      });
    }

    function updateSaveButtonState(button, isSaved) {
      if (!button) return;
      const icon = button.querySelector('i');
      const label = button.querySelector('span');

      if (isSaved) {
        button.classList.add('saved');
        if (icon) { icon.classList.remove('far'); icon.classList.add('fas'); }
        if (label) label.textContent = 'Saved';
      } else {
        button.classList.remove('saved');
        if (icon) { icon.classList.remove('fas'); icon.classList.add('far'); }
        if (label) label.textContent = 'Save Item';
      }
    }

    function renderSavedItems() {
      const listEl = document.getElementById('savedItemsList');
      const emptyEl = document.getElementById('savedItemsEmpty');
      if (!listEl || !emptyEl) return;

      const items = getSavedItems();
      listEl.innerHTML = '';

      if (!items.length) {
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';

      items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'saved-item';
        const savedDate = item.savedAt ? new Date(item.savedAt) : null;
        const dateText = savedDate
          ? savedDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
          : '';

        li.innerHTML = `
          <div class="saved-item-title-row">
            <span class="saved-item-title">${item.title}</span>
            <span class="saved-item-type">${item.type}</span>
          </div>
          <div class="saved-item-meta">${dateText ? `Saved on ${dateText}` : ''}</div>
          <a class="saved-item-link" href="${item.link}">
            Open <i class="fas fa-arrow-right"></i>
          </a>
        `;
        listEl.appendChild(li);
      });
    }
  </script>

  <!-- ✅ ONE unified Supabase module:
       - Locks tool behind sign-in
       - Loads header (initials + plan)
       - Enables Save Progress button (manual only)
       - Saves progress to tool_states ONLY on button click
       - Logs activity events safely
  -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ===========================
       SUPABASE INIT
    =========================== */
    const SB_URL = window.TEP_SUPABASE_URL;
    const SB_KEY = window.TEP_SUPABASE_ANON_KEY;
    const supabase = (SB_URL && SB_KEY) ? createClient(SB_URL, SB_KEY) : null;

    /* ===========================
       HELPERS (WERE MISSING → FIXED)
    =========================== */
    function planLabel(raw) {
      const p = (raw || "").toString().trim().toLowerCase();
      if (!p) return "Free";
      if (p.includes("edge")) return "Strategic Edge";
      if (p.includes("strategic")) return "Strategic Edge";
      if (p.includes("core")) return "Core";
      if (p.includes("free")) return "Free";
      return raw.toString().trim();
    }

    function initialsFrom(fullName, email) {
      const name = (fullName || "").trim();
      if (name) {
        const parts = name.split(/\s+/).filter(Boolean);
        const a = parts[0]?.[0] || "";
        const b = parts.length > 1 ? (parts[parts.length - 1]?.[0] || "") : "";
        const init = (a + b).toUpperCase();
        return init || "ME";
      }
      const em = (email || "").trim();
      if (em) return em.slice(0, 2).toUpperCase();
      return "ME";
    }

    async function getAuthedUser() {
      if (!supabase) return null;
      const { data } = await supabase.auth.getUser();
      return data?.user || null;
    }

    /* ===========================
       CONSTANTS
    =========================== */
    const TOOL_ID = "capacity-checklist";
    const TOOL_VERSION = 1;

    /* ===========================
       ELEMENTS
    =========================== */
    const initialsBtn = document.getElementById("userInitialsBtn");
    const planPill = document.getElementById("userPlanPill");
    const mobileProfileBtn = document.getElementById("mobileProfileBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const authOverlay = document.getElementById("authLockOverlay");
    const saveProgressBtn = document.getElementById("saveProgressBtn");
    const saveProgressStatus = document.getElementById("saveProgressStatus");

    function toastSaveStatus(msg, type = "info") {
      if (!saveProgressStatus) return;
      saveProgressStatus.textContent = msg || "";
      saveProgressStatus.style.color =
        type === "ok" ? "var(--success-green)" :
        type === "err" ? "var(--danger-red)" :
        "var(--dark-gray)";
    }

    async function safeLogActivity(event_name, meta = {}) {
      try {
        if (!supabase) return;
        const user = await getAuthedUser();
        if (!user) return;

        await supabase.from("activity_log").insert([{
          user_id: user.id,
          event_name,
          meta,
          created_at: new Date().toISOString()
        }]);
      } catch (e) {
        // fail silently
      }
    }

    /* ===========================
       AUTH LOCK (SINGLE VERSION) ✅ no duplicates
    =========================== */
    function setToolLocked(isLocked) {
      document.body.classList.toggle("auth-locked", !!isLocked);

      if (authOverlay) {
        authOverlay.classList.toggle("active", !!isLocked);
        authOverlay.setAttribute("aria-hidden", isLocked ? "false" : "true");
      }

      // Hard disable key buttons when locked
      const idsToDisable = ["generateBtn", "clearBtn", "saveProgressBtn", "copyBtn", "printBtn"];
      idsToDisable.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.disabled = !!isLocked || el.disabled;
      });

      // Manual save disabled unless signed in
      if (saveProgressBtn) saveProgressBtn.disabled = !!isLocked;

      if (saveProgressStatus && isLocked) saveProgressStatus.textContent = "";
    }

    function setSignedOutHeader() {
      if (initialsBtn) {
        initialsBtn.textContent = "…";
        initialsBtn.href = "sign-in.html";
      }
      if (mobileProfileBtn) mobileProfileBtn.href = "sign-in.html";
      if (planPill) planPill.textContent = "Free";
      if (logoutBtn) logoutBtn.style.display = "none";
    }

    function setSignedInHeader({ initials, plan }) {
      if (initialsBtn) {
        initialsBtn.textContent = initials || "ME";
        initialsBtn.href = "profile.html";
      }
      if (mobileProfileBtn) mobileProfileBtn.href = "profile.html";
      if (planPill) planPill.textContent = planLabel(plan);
      if (logoutBtn) logoutBtn.style.display = "inline-flex";
    }

    /* ===========================
       PROFILE / PLAN LOOKUP
    =========================== */
    async function getUserPlanAndName(user) {
      const fallbackName =
        user?.user_metadata?.full_name ||
        user?.user_metadata?.name ||
        "";

      const fallbackPlan =
        user?.user_metadata?.plan ||
        user?.app_metadata?.plan ||
        "Free";

      try {
        const { data, error } = await supabase
          .from("profiles")
          .select("full_name, plan")
          .eq("id", user.id)
          .maybeSingle();

        if (!error && data) {
          return {
            full_name: data.full_name || fallbackName,
            plan: data.plan || fallbackPlan
          };
        }
      } catch (e) {}

      return { full_name: fallbackName, plan: fallbackPlan };
    }

    /* ===========================
       TOOL STATE (LOAD + SAVE)
       - Save ONLY on button click
    =========================== */
    function getLocalSnapshot() {
      return {
        tool_id: TOOL_ID,
        version: TOOL_VERSION,
        updated_at: new Date().toISOString(),
        checkedItems: Array.isArray(window.checkedItems) ? window.checkedItems : []
      };
    }

    function applySnapshot(snapshot) {
      try {
        const arr = snapshot?.checkedItems;
        if (!Array.isArray(arr)) return;

        const items = document.querySelectorAll(".checklist-item");
        const max = Math.min(items.length, arr.length);

        if (!Array.isArray(window.checkedItems) || window.checkedItems.length !== items.length) {
          window.checkedItems = new Array(items.length).fill(false);
        }

        for (let i = 0; i < max; i++) {
          const container = items[i];
          const icon = container?.querySelector("i");
          const checked = !!arr[i];

          window.checkedItems[i] = checked;

          // mirror the main script checkbox rendering
          if (icon) {
            if (checked) {
              icon.classList.remove("fa-square", "far");
              icon.classList.add("fa-check-square", "fas");
              icon.style.color = "#5A4496";
            } else {
              icon.classList.remove("fa-check-square", "fas");
              icon.classList.add("fa-square", "far");
              icon.style.color = "#7B5FC4";
            }
          }
        }

        if (typeof window.updateCapacityScore === "function") window.updateCapacityScore();
      } catch (e) {}
    }

    async function loadToolStateFromCloud(user) {
      if (!supabase || !user) return;
      try {
        const { data, error } = await supabase
          .from("tool_states")
          .select("state")
          .eq("user_id", user.id)
          .eq("tool_id", TOOL_ID)
          .order("updated_at", { ascending: false })
          .limit(1)
          .maybeSingle();

        if (error || !data?.state) return;
        applySnapshot(data.state);
        toastSaveStatus("Loaded your saved progress.", "ok");
      } catch (e) {}
    }

    async function saveToolStateToCloud(user) {
      if (!supabase || !user) return { ok: false, message: "Not signed in." };

      const snapshot = getLocalSnapshot();

      try {
        const { error } = await supabase
          .from("tool_states")
          .upsert([{
            user_id: user.id,
            tool_id: TOOL_ID,
            tool_version: TOOL_VERSION,
            state: snapshot,
            updated_at: new Date().toISOString()
          }], { onConflict: "user_id,tool_id" });

        if (error) return { ok: false, message: error.message || "Save failed." };
        return { ok: true, message: "Progress saved to your account." };
      } catch (e) {
        return { ok: false, message: "Save failed." };
      }
    }

    /* ===========================
       PAGE INIT (AUTH + LOCK)
    =========================== */
    async function handleSignedOut() {
      setSignedOutHeader();
      setToolLocked(true);
      toastSaveStatus("");
    }

    async function handleSignedIn(user) {
      const { full_name, plan } = await getUserPlanAndName(user);
      const initials = initialsFrom(full_name, user.email);

      setSignedInHeader({ initials, plan });
      setToolLocked(false);

      if (typeof window.updateCapacityScore === "function") window.updateCapacityScore();

      await loadToolStateFromCloud(user);

      if (typeof window.updateCapacityScore === "function") window.updateCapacityScore();

      await safeLogActivity("tool_opened", { tool_id: TOOL_ID, tool_version: TOOL_VERSION });
    }

    async function initAuthAndLock() {
      if (!supabase) {
        setSignedOutHeader();
        setToolLocked(true);
        toastSaveStatus("Missing Supabase config.", "err");
        return;
      }

      const user = await getAuthedUser();
      if (!user) await handleSignedOut();
      else await handleSignedIn(user);

      supabase.auth.onAuthStateChange(async (_event, session) => {
        const u = session?.user || null;
        if (!u) await handleSignedOut();
        else await handleSignedIn(u);
      });
    }

    /* ===========================
       LOGOUT
    =========================== */
    function wireLogout() {
      if (!logoutBtn) return;
      logoutBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (!supabase) return;
        try {
          await safeLogActivity("logout_clicked", { tool_id: TOOL_ID });
          await supabase.auth.signOut();
          window.location.href = "sign-in.html";
        } catch (e2) {
          window.location.href = "sign-in.html";
        }
      });
    }

    /* ===========================
       SAVE PROGRESS (MANUAL ONLY)
    =========================== */
    function wireSaveProgress() {
      if (!saveProgressBtn) return;

      saveProgressBtn.addEventListener("click", async () => {
        toastSaveStatus("Saving…");
        saveProgressBtn.disabled = true;

        const user = await getAuthedUser();
        if (!user) {
          toastSaveStatus("Please sign in to save.", "err");
          setToolLocked(true);
          saveProgressBtn.disabled = false;
          return;
        }

        const res = await saveToolStateToCloud(user);
        if (res.ok) {
          toastSaveStatus(res.message, "ok");
          await safeLogActivity("tool_saved", { tool_id: TOOL_ID, tool_version: TOOL_VERSION });
        } else {
          toastSaveStatus(res.message || "Save failed.", "err");
        }

        saveProgressBtn.disabled = false;
      });
    }

    /* ===========================
       BOOT
    =========================== */
    wireLogout();
    wireSaveProgress();
    initAuthAndLock();
  </script>

</body>
</html>
