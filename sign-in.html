<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In | The Employee Playbook</title>

  <!-- Basic metadata -->
  <meta name="description" content="Sign in to The Employee Playbook to access your tools, saved progress, and account." />
  <meta name="robots" content="index,follow" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --white: #fff;
      --light-gray: #f7f7f7;
      --gray: #e0e0e0;
      --dark-gray: #6b6b6b;
      --text: #37352f;
      --accent: #7B5FC4;
      --accent-dark: #5A4496;
      --shadow: 0 2px 10px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 15px rgba(0,0,0,0.12);
      --danger: #c0392b;
      --success: #1f7a4f;
      --info: #2f6fd6;
      --focus: rgba(123, 95, 196, 0.22);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

    body {
      background: linear-gradient(135deg, #f0f2ff 0%, var(--white) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      width: 100%;
      max-width: 520px;
      padding: 36px 28px;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray);
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.4s ease-out;
    }

    .login-container::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 4px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    }

    .login-header { text-align: center; margin-bottom: 18px; }

    .logo-container { display: flex; justify-content: center; margin-bottom: 18px; }

    .logo { height: 70px; width: auto; }

    .logo-fallback {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
      display: none;
      letter-spacing: 0.2px;
    }

    .login-title { font-size: 28px; font-weight: 700; margin-bottom: 10px; color: var(--text); }
    .login-subtitle { font-size: 15px; color: var(--dark-gray); line-height: 1.5; }

    .login-form { display: flex; flex-direction: column; gap: 16px; }

    .form-group { display: flex; flex-direction: column; gap: 6px; }

    .form-label { font-size: 13px; font-weight: 500; color: var(--text); }

    .form-input {
      padding: 14px 16px;
      border: 1px solid var(--gray);
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
      width: 100%;
      background: var(--white);
      color: var(--text);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus);
    }

    .password-input-container { position: relative; width: 100%; }
    .password-input { padding-right: 46px; }

    .password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 13px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s, box-shadow 0.2s;
      border-radius: 8px;
    }
    .password-toggle:hover { color: var(--accent); }
    .password-toggle:focus { outline: none; box-shadow: 0 0 0 3px var(--focus); }

    .form-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      gap: 10px;
    }

    .remember-me { display: flex; align-items: center; gap: 6px; }
    .remember-checkbox { width: 14px; height: 14px; accent-color: var(--accent); }
    .remember-label { font-size: 13px; color: var(--dark-gray); cursor: pointer; }

    /* ✅ Forgot password is UI control -> button, not a link */
    .forgot-password {
      font-size: 13px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s, box-shadow 0.2s;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 8px;
      white-space: nowrap;
    }
    .forgot-password:hover { color: var(--accent-dark); text-decoration: underline; }
    .forgot-password:focus { outline: none; box-shadow: 0 0 0 3px var(--focus); }

    .login-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 14px 18px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
      margin-top: 5px;
      width: 100%;
      box-shadow: 0 3px 8px rgba(123, 95, 196, 0.2);
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .login-button:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(123, 95, 196, 0.3);
    }

    .login-button:focus { outline: none; box-shadow: 0 0 0 3px var(--focus), 0 4px 10px rgba(123, 95, 196, 0.26); }

    .login-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .signup-link {
      text-align: center;
      margin-top: 18px;
      font-size: 13px;
      color: var(--dark-gray);
      line-height: 1.45;
    }

    .signup-link a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
      transition: color 0.2s;
    }
    .signup-link a:hover { color: var(--accent-dark); }

    .legal {
      margin-top: 10px;
      font-size: 12px;
      color: var(--dark-gray);
      text-align: center;
      line-height: 1.45;
    }
    .legal a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
    }
    .legal a:hover { color: var(--accent-dark); text-decoration: underline; }

    .status {
      display: none;
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.35;
      border: 1px solid var(--gray);
      background: var(--light-gray);
      color: var(--text);
    }
    .status.error {
      display: block;
      border-color: rgba(192, 57, 43, 0.25);
      background: rgba(192, 57, 43, 0.08);
      color: var(--danger);
    }
    .status.success {
      display: block;
      border-color: rgba(31, 122, 79, 0.25);
      background: rgba(31, 122, 79, 0.08);
      color: var(--success);
    }
    .status.info {
      display: block;
      border-color: rgba(47, 111, 214, 0.22);
      background: rgba(47, 111, 214, 0.06);
      color: var(--info);
    }

    /* ✅ Forgot password inline panel */
    .forgot-panel{
      display:none;
      border: 1px solid rgba(123, 95, 196, 0.18);
      background: rgba(123, 95, 196, 0.06);
      border-radius: 10px;
      padding: 12px 12px;
      margin-top: -6px;
    }
    .forgot-panel.show{ display:block; }
    .forgot-title{
      font-size: 13px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 6px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .forgot-title i{ color: var(--accent); }
    .forgot-hint{
      font-size: 12.5px;
      color: var(--dark-gray);
      line-height:1.35;
      margin-bottom: 10px;
    }
    .forgot-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }
    .mini-btn{
      border:none;
      background: var(--accent);
      color:#fff;
      font-weight: 800;
      border-radius: 8px;
      padding: 10px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 3px 8px rgba(123, 95, 196, 0.18);
      transition: all .2s;
      font-size: 13px;
    }
    .mini-btn:hover{
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(123, 95, 196, 0.22);
    }
    .mini-btn:focus{ outline:none; box-shadow: 0 0 0 3px var(--focus), 0 4px 12px rgba(123, 95, 196, 0.22); }
    .mini-btn:disabled{ opacity:.7; cursor:not-allowed; transform:none; }

    .mini-link{
      border:none;
      background: transparent;
      color: var(--accent);
      font-weight: 800;
      cursor:pointer;
      font-size: 13px;
      padding: 8px 6px;
      border-radius: 8px;
      transition: box-shadow .2s;
    }
    .mini-link:hover{ text-decoration: underline; }
    .mini-link:focus{ outline:none; box-shadow: 0 0 0 3px var(--focus); }

    @media (max-width: 480px) {
      body { padding: 15px; }
      .login-container { padding: 25px 20px; max-width: 100%; }
      .logo { height: 60px; }
      .login-title { font-size: 22px; }
      .login-subtitle { font-size: 13px; }
      .form-options { align-items: flex-start; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="login-header">
      <div class="logo-container">
        <img
          src="assets/img/logo.png"
          alt="The Employee Playbook"
          class="logo"
          id="logo"
          onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';"
        >
        <div class="logo-fallback" id="logo-fallback">THE EMPLOYEE PLAYBOOK</div>
      </div>

      <h1 class="login-title">Sign In</h1>
      <p class="login-subtitle">Access your Employee Playbook account</p>
    </div>

    <form class="login-form" id="loginForm">
      <div class="form-group">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" id="email" class="form-input" placeholder="you@example.com" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="password" class="form-label">Password</label>
        <div class="password-input-container">
          <input type="password" id="password" class="form-input password-input" placeholder="Enter your password" required autocomplete="current-password">
          <button type="button" class="password-toggle" id="passwordToggle" aria-label="Show/hide password">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <div class="form-options">
        <div class="remember-me">
          <input type="checkbox" id="remember" class="remember-checkbox" checked>
          <label for="remember" class="remember-label">Remember me</label>
        </div>

        <!-- ✅ UI control button -->
        <button type="button" class="forgot-password" id="forgotLink">Forgot password?</button>
      </div>

      <!-- ✅ Inline reset panel -->
      <div class="forgot-panel" id="forgotPanel" aria-hidden="true">
        <div class="forgot-title"><i class="fa-solid fa-key"></i> Reset your password</div>
        <div class="forgot-hint">
          We’ll email a secure reset link. If your account exists, it will arrive within a few minutes.
        </div>
        <div class="forgot-actions">
          <button type="button" class="mini-btn" id="sendResetBtn">
            <span id="sendResetText">Send reset link</span>
            <i class="fa-solid fa-paper-plane" id="sendResetIcon"></i>
          </button>
          <button type="button" class="mini-link" id="cancelResetBtn">Cancel</button>
        </div>
      </div>

      <button type="submit" class="login-button" id="loginBtn">
        <span>Sign In</span>
        <i class="fas fa-arrow-right"></i>
      </button>

      <div id="statusBox" class="status" role="status" aria-live="polite"></div>

      <div class="signup-link">
        Don't have an account? <a href="create-account.html">Sign up here</a>
        <div class="legal">
          By continuing, you agree to our
          <a href="terms.html">Terms</a> and
          <a href="privacy.html">Privacy Policy</a>.
          <br>
          Need help? <a href="support.html">Support</a>
        </div>
      </div>
    </form>
  </div>

  <!-- Load Supabase ONCE + your client ONCE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Password toggle
      const toggleBtn = document.getElementById('passwordToggle');
      const passwordInput = document.getElementById('password');

      toggleBtn.addEventListener('click', function () {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);

        const icon = this.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
      });

      const supabaseClient = window.supabaseClient;

      const statusBox = document.getElementById('statusBox');
      const loginBtn = document.getElementById('loginBtn');
      const emailEl = document.getElementById('email');

      // Forgot panel elements
      const forgotLink = document.getElementById('forgotLink');
      const forgotPanel = document.getElementById('forgotPanel');
      const sendResetBtn = document.getElementById('sendResetBtn');
      const sendResetText = document.getElementById('sendResetText');
      const sendResetIcon = document.getElementById('sendResetIcon');
      const cancelResetBtn = document.getElementById('cancelResetBtn');

      function setStatus(type, msg) {
        statusBox.className = 'status ' + (type || '');
        statusBox.innerHTML = msg || '';
        statusBox.style.display = msg ? 'block' : 'none';
      }

      function setLoading(isLoading) {
        loginBtn.disabled = !!isLoading;
        const label = loginBtn.querySelector('span');
        const icon = loginBtn.querySelector('i');
        if (isLoading) {
          label.textContent = 'Signing in…';
          icon.className = 'fas fa-circle-notch fa-spin';
        } else {
          label.textContent = 'Sign In';
          icon.className = 'fas fa-arrow-right';
        }
      }

      function setResetLoading(isLoading){
        sendResetBtn.disabled = !!isLoading;
        if (isLoading) {
          sendResetText.textContent = 'Sending…';
          sendResetIcon.className = 'fa-solid fa-circle-notch fa-spin';
        } else {
          sendResetText.textContent = 'Send reset link';
          sendResetIcon.className = 'fa-solid fa-paper-plane';
        }
      }

      function escapeHtml(str){
        return String(str || '').replace(/[&<>"']/g, (m) => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
        }[m]));
      }

      // ✅ Allowlist internal destinations (Phase 1 hardening)
      function safeInternalPath(p) {
        const val = (p || '').trim();
        if (!val) return null;

        // Block absolute URLs
        if (/^https?:\/\//i.test(val)) return null;

        // Normalise
        const cleaned = val.replace(/^(\.\/|\/)+/, '');

        // Phase 1 allowlist (add to this as needed)
        const allow = new Set([
          'the-toolkit.html',
          'index.html',
          'account.html'
        ]);

        return allow.has(cleaned) ? cleaned : null;
      }

      function getPostLoginRedirect() {
        const params = new URLSearchParams(window.location.search);
        const returnTo = params.get('returnTo');
        const next = params.get('next');
        const storedReturnTo = localStorage.getItem('returnTo');
        const storedNext = localStorage.getItem('tep_post_login_redirect');

        return (
          safeInternalPath(returnTo) ||
          safeInternalPath(next) ||
          safeInternalPath(storedReturnTo) ||
          safeInternalPath(storedNext) ||
          'the-toolkit.html'
        );
      }

      function cleanUrl(removeKeys = []) {
        const url = new URL(window.location.href);
        removeKeys.forEach(k => url.searchParams.delete(k));
        window.history.replaceState({}, document.title, url.toString());
      }

      // ✅ Premium error mapper
      function premiumAuthErrorMessage(error) {
        const raw = (error && error.message) ? String(error.message) : '';
        const msg = raw.toLowerCase();

        if (msg.includes('email not confirmed')) {
          return {
            type: 'info',
            html: "Please confirm your email before signing in.<br><span style='color:var(--dark-gray);font-weight:600;'>Open the verification link we emailed you, then return here.</span>"
          };
        }

        if (msg.includes('invalid login credentials') || msg.includes('invalid') || msg.includes('credentials')) {
          return {
            type: 'error',
            html: "Email or password doesn’t match.<br><span style='color:var(--dark-gray);font-weight:600;'>Try again — or reset your password if you’ve forgotten it.</span>"
          };
        }

        if (msg.includes('too many requests') || msg.includes('rate limit')) {
          return {
            type: 'error',
            html: "Too many attempts in a short time.<br><span style='color:var(--dark-gray);font-weight:600;'>Please wait a moment and try again.</span>"
          };
        }

        if (msg.includes('fetch') || msg.includes('network') || msg.includes('failed to fetch')) {
          return {
            type: 'error',
            html: "We couldn’t reach the service just now.<br><span style='color:var(--dark-gray);font-weight:600;'>Check your connection and try again.</span>"
          };
        }

        return {
          type: 'error',
          html: (raw ? escapeHtml(raw) : "Sign-in failed. Please try again.")
        };
      }

      function setForgotPanel(open){
        forgotPanel.classList.toggle('show', !!open);
        forgotPanel.setAttribute('aria-hidden', open ? 'false' : 'true');
      }

      // ✅ Guard: Supabase must exist
      if (!supabaseClient || !supabaseClient.auth) {
        setStatus('error',
          "We couldn’t initialise sign-in.<br><span style='color:var(--dark-gray);font-weight:600;'>Please refresh the page. If this continues, contact support.</span>"
        );
        // still allow UI usage (no hard crash)
        return;
      }

      // ✅ Auth listener (Phase 1 stability for delayed sessions / magic links)
      try {
        supabaseClient.auth.onAuthStateChange((_event, session) => {
          if (session) {
            window.location.href = getPostLoginRedirect();
          }
        });
      } catch (e) { /* silent */ }

      // ✅ 0) If already signed in, bounce them to destination
      (async function redirectIfAlreadySignedIn(){
        try {
          const { data } = await supabaseClient.auth.getSession();
          if (data && data.session) {
            window.location.href = getPostLoginRedirect();
          }
        } catch (e) { /* silent */ }
      })();

      // 1) Show friendly “state” messages (from your redirects)
      (function showQueryMessages(){
        const params = new URLSearchParams(window.location.search);

        // Prefill email if provided
        const emailParam = params.get('email');
        if (emailParam && emailEl) emailEl.value = emailParam;

        if (params.get('check_email') === '1') {
          const shownEmail = emailParam ? `<strong>${escapeHtml(emailParam)}</strong>` : 'your inbox';
          setStatus('success',
            `Check your email to verify your account (${shownEmail}).<br><span style="color:var(--dark-gray);font-weight:600;">Open the secure link, then come back and sign in.</span>`
          );
          cleanUrl(['check_email']);
        } else if (params.get('reset') === '1') {
          setStatus('success', 'Password updated. You can sign in now.');
          cleanUrl(['reset']);
        } else if (params.get('confirmed') === '1') {
          setStatus('success', 'Email confirmed. You can sign in now.');
          cleanUrl(['confirmed']);
        } else if (params.get('error_description')) {
          setStatus('error', escapeHtml(params.get('error_description')));
          cleanUrl(['error_description']);
        }
      })();

      // 2) Handle Supabase email-link callbacks (signup + recovery) on this page
      //    Links often arrive with: ?type=signup|recovery&token_hash=...
      (async function handleEmailLinkCallback(){
        const params = new URLSearchParams(window.location.search);
        const type = params.get('type'); // 'signup' | 'recovery' | etc
        const token_hash = params.get('token_hash');

        if (!type || !token_hash) return;

        setLoading(true);

        try {
          const { error } = await supabaseClient.auth.verifyOtp({ type, token_hash });

          if (error) {
            setStatus('error',
              "This link is invalid or has expired.<br><span style='color:var(--dark-gray);font-weight:600;'>Please request a new one.</span>"
            );
            return;
          }

          if (type === 'recovery') {
            setStatus('success', "Link verified.<br><span style='color:var(--dark-gray);font-weight:600;'>Redirecting to set a new password…</span>");
            cleanUrl(['type', 'token_hash']);

            // ✅ Folder-safe redirect
            const dest = new URL('update-password.html', window.location.href).toString();
            setTimeout(() => window.location.href = dest, 650);
            return;
          }

          setStatus('success', 'Email confirmed successfully. You can sign in now.');
          cleanUrl(['type', 'token_hash']);

        } catch (e) {
          console.error(e);
          setStatus('error',
            "Something went wrong verifying your link.<br><span style='color:var(--dark-gray);font-weight:600;'>Please request a new one.</span>"
          );
        } finally {
          setLoading(false);
        }
      })();

      // ✅ Forgot password inline panel
      forgotLink.addEventListener('click', () => setForgotPanel(!forgotPanel.classList.contains('show')));
      cancelResetBtn.addEventListener('click', () => setForgotPanel(false));

      sendResetBtn.addEventListener('click', async () => {
        setStatus('', '');
        const email = (emailEl.value || '').trim();

        if (!email) {
          setStatus('error', "Enter your email address above, then try again.");
          emailEl.focus();
          return;
        }

        setResetLoading(true);

        try {
          // ✅ Folder-safe redirect
          const redirectTo = new URL('update-password.html', window.location.href).toString();

          const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo });

          // Always show success-style message (don’t leak if account exists)
          if (error) {
            setStatus('info',
              "If an account exists for that email, we’ve sent a secure reset link.<br><span style='color:var(--dark-gray);font-weight:600;'>Please check your inbox (and spam/junk).</span>"
            );
          } else {
            setStatus('success',
              `If an account exists for <strong>${escapeHtml(email)}</strong>, we’ve sent a secure reset link.<br><span style='color:var(--dark-gray);font-weight:600;'>Please check your inbox (and spam/junk).</span>`
            );
          }

          setForgotPanel(false);

        } catch (e) {
          console.error(e);
          setStatus('error',
            "Something went wrong.<br><span style='color:var(--dark-gray);font-weight:600;'>Please try again.</span>"
          );
        } finally {
          setResetLoading(false);
        }
      });

      // 3) Normal sign-in
      document.getElementById('loginForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        setStatus('', '');
        setLoading(true);

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        try {
          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

          if (error) {
            const mapped = premiumAuthErrorMessage(error);
            setStatus(mapped.type, mapped.html);
            return;
          }

          if (!data || !data.session) {
            setStatus('error',
              "Signed in, but no session was returned.<br><span style='color:var(--dark-gray);font-weight:600;'>Please check your Supabase auth settings.</span>"
            );
            return;
          }

          setStatus('success', "Signed in successfully.<br><span style='color:var(--dark-gray);font-weight:600;'>Redirecting…</span>");

          const dest = getPostLoginRedirect();

          localStorage.removeItem('returnTo');
          localStorage.removeItem('tep_post_login_redirect');

          window.location.href = dest;

        } catch (err) {
          console.error(err);
          setStatus('error',
            "Something went wrong.<br><span style='color:var(--dark-gray);font-weight:600;'>Please try again.</span>"
          );
        } finally {
          setLoading(false);
        }
      });
    });
  </script>

</body>
</html>
