<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Capacity Checklist | The Employee Playbook</title>

  <!-- ICONS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">

  <!-- THEME PRELOAD (prevents flash + keeps toggle consistent across pages) -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme'); // "dark" | "light" | null
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.documentElement.classList.add('dark-mode');
      } catch (e) {}
    })();
  </script>

  <style>
    /* ===========================
       ROOT VARIABLES (From Homepage)
    =========================== */
    :root {
      --primary-white: #FFFFFF;
      --light-gray: #F8F9FA;
      --medium-gray: #E9ECEF;
      --dark-gray: #6C757D;
      --text-dark: #212529;
      --text-medium: #495057;
      --accent-purple: #7B5FC4;
      --accent-purple-dark: #5A4496;
      --light-purple: #E6E0F5;
      --lighter-purple: #F0EBFA;
      --border-light: rgba(0, 0, 0, 0.08);
      --hero-gray: #f5f7fa;
      --nav-bg: rgba(255, 255, 255, 0.95);
      --hero-bg: linear-gradient(135deg, #F9F6FF 0%, #F0EBFA 100%);
      --premium-gradient: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --danger-red: #ef4444;
      --info-blue: #3b82f6;
      --teal: #14b8a6;
      --pink: #ec4899;
      --indigo: #6366f1;
      --capacity-green: #059669;
      --capacity-yellow: #d97706;
      --capacity-red: #dc2626;
    }

    /* Dark Mode Variables (applied to html.dark-mode) */
    .dark-mode {
      --primary-white: #1a1a1a;
      --light-gray: #2a2a2a;
      --medium-gray: #3a3a3a;
      --dark-gray: #888888;
      --text-dark: #e0e0e0;
      --text-medium: #b0b0b0;
      --accent-purple: #9d86e9;
      --accent-purple-dark: #7b5fc4;
      --light-purple: rgba(123, 95, 196, 0.2);
      --lighter-purple: rgba(123, 95, 196, 0.1);
      --border-light: rgba(255, 255, 255, 0.08);
      --hero-gray: #2a2a2a;
      --nav-bg: rgba(30, 30, 30, 0.95);
      --hero-bg: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      --premium-gradient: linear-gradient(135deg, #9d86e9 0%, #7b5fc4 100%);
      --capacity-green: #10b981;
      --capacity-yellow: #f59e0b;
      --capacity-red: #ef4444;
    }

    /* ===========================
       GLOBAL STYLES
    =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      background-color: var(--primary-white);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.4s ease;
      min-height: 100vh;
    }

    body.loaded { opacity: 1; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===========================
       NAVIGATION (Pixel Perfect from Homepage)
    =========================== */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000;
      border-bottom: 1px solid var(--border-light);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease, border-color 0.3s ease;
      height: 80px;
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      height: 100%;
    }

    .logo-img {
      height: 100px;
      width: auto;
      transform: translateX(20%);
      padding: 14px 10px;
      transition: all 0.3s ease;
      display: block;
      min-height: 100px;
    }

    .logo-img.fallback {
      width: 200px;
      height: 50px;
      background: var(--accent-purple);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      border-radius: 4px;
      transform: translateX(20%);
    }

    .nav-links {
      display: flex;
      gap: 50px;
    }

    .nav-link {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      font-size: 17px;
    }

    .nav-link:hover {
      color: var(--accent-purple);
    }

    .nav-link-container {
      position: relative;
      display: inline-block;
    }

    .new-tag {
      position: absolute;
      top: -12px;
      right: -35px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
      white-space: nowrap;
    }

    .dark-mode .new-tag {
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 24px;
      transform: translateX(-20%);
    }

    .header-cta {
      background: var(--accent-purple);
      color: white;
      padding: 8px 20px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(123, 95, 196, 0.3);
    }

    .header-cta:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(123, 95, 196, 0.35);
    }

    .dark-mode .header-cta {
      box-shadow: 0 5px 15px rgba(123, 95, 196, 0.5);
    }

    .sign-in {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      font-size: 17px;
    }

    .sign-in:hover { color: var(--accent-purple); }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .theme-toggle:hover { background-color: var(--light-gray); }

    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .mobile-toggle:hover { background-color: var(--light-gray); }

    .mobile-sign-in,
    .mobile-sign-up { display: none; }

    @media (max-width: 768px) {
      .nav-container { justify-content: center; position: relative; }

      .logo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        height: 100%;
      }

      .logo-img { height: 125px; transform: none; padding: 12px 0; }

      .mobile-toggle {
        display: flex;
        position: absolute;
        left: 20px;
        align-items: center;
      }

      .nav-actions {
        transform: none;
        gap: 16px;
        position: absolute;
        right: 20px;
        align-items: center;
      }

      .nav-actions .sign-in,
      .nav-actions .header-cta { display: none; }

      .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: var(--nav-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        flex-direction: column;
        padding: 20px;
        border-top: 1px solid var(--border-light);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        gap: 20px;
      }

      .nav-links.active { display: flex; }

      .nav-link-container {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
      }

      .new-tag { position: static; margin-left: 8px; }

      .mobile-sign-in {
        display: block !important;
        margin-top: 10px;
        padding: 12px 20px;
        background: var(--primary-white);
        color: var(--accent-purple);
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        text-decoration: none;
        border: 2px solid var(--accent-purple);
        transition: all 0.3s ease;
      }

      .mobile-sign-in:hover { background: var(--light-gray); transform: translateY(-2px); }

      .mobile-sign-up {
        display: block !important;
        margin-top: 10px;
        padding: 12px 20px;
        background: var(--accent-purple);
        color: white;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        text-decoration: none;
        border: 2px solid var(--accent-purple);
        transition: all 0.3s ease;
      }

      .mobile-sign-up:hover { background: var(--accent-purple-dark); transform: translateY(-2px); }
    }

    /* ===========================
       ENHANCED HERO SECTION
    =========================== */
    .tool-hero-section {
      width: 100%;
      background: var(--hero-bg);
      padding: 20px 0 30px;
      margin-top: 110px;
      position: relative;
      border-bottom: 1px solid var(--border-light);
      overflow: hidden;
    }

    .tool-hero-section::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 100%;
      background: linear-gradient(135deg, rgba(250, 245, 255, 0.85) 0%, rgba(245, 240, 255, 0.6) 50%, rgba(255, 255, 255, 0.25) 100%);
      z-index: 1;
    }

    .dark-mode .tool-hero-section::before {
      background: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(31, 31, 31, 0.7) 50%, rgba(26, 26, 26, 0.4) 100%);
    }

    .tool-hero-section::after {
      content: '';
      position: absolute;
      bottom: -30px;
      left: 0; right: 0;
      height: 60px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.06), transparent);
      opacity: 0.25;
      pointer-events: none;
    }

    .dark-mode .tool-hero-section::after {
      background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    }

    .tool-hero-content {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 10px;
      animation: heroFadeUp 0.45s ease-out;
    }

    @keyframes heroFadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Breadcrumb styling */
    .breadcrumb {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--dark-gray);
      margin-bottom: 10px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .breadcrumb a {
      color: var(--text-medium);
      text-decoration: none !important;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: color 0.2s ease;
    }

    .breadcrumb a:hover { color: var(--accent-purple-dark); }

    .breadcrumb i { color: var(--dark-gray); opacity: 0.8; }
    .breadcrumb .current { color: var(--text-dark); font-weight: 600; }

    /* Save Item button in hero (top-right of hero) */
    .save-btn {
      position: absolute;
      top: 16px;
      right: 24px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.6);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--accent-purple-dark);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .save-btn i { font-size: 13px; }

    .save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(123, 95, 196, 0.18);
      background: #ffffff;
    }

    .dark-mode .save-btn {
      background: rgba(20, 20, 20, 0.9);
      border-color: rgba(157, 134, 233, 0.6);
    }

    .save-btn.saved {
      background: var(--accent-purple);
      color: #ffffff;
      border-color: transparent;
    }

    /* NEW: Save status chip */
    .save-status {
      position: absolute;
      top: 16px;
      right: 118px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--text-medium);
      opacity: 0;
      transform: translateY(-2px);
      transition: opacity .2s ease, transform .2s ease;
      pointer-events: none;
      white-space: nowrap;
    }

    .dark-mode .save-status {
      background: rgba(20, 20, 20, 0.65);
      border-color: rgba(255,255,255,0.10);
    }

    .save-status.show {
      opacity: 1;
      transform: translateY(0);
    }

    .save-status.good { color: var(--success-green); }
    .save-status.warn { color: var(--warning-orange); }
    .save-status.bad  { color: var(--danger-red); }

    .checklist-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-purple);
      text-transform: uppercase;
      letter-spacing: 1.8px;
      margin-bottom: 14px;
      margin-top: 32px;
      display: block;
    }

    .hero-main-heading {
      font-size: 46px;
      font-weight: 600;
      color: var(--text-dark);
      line-height: 1.1;
      margin-bottom: 20px;
      max-width: 1100px;
    }

    .hero-subheading {
      font-size: 16px;
      color: var(--text-medium);
      line-height: 1.6;
      max-width: 9000px;
      margin-bottom: 30px;
    }

    /* ===========================
       CATEGORY PILLS SECTION
    =========================== */
    .category-pills-container { margin-bottom: 30px; }

    .category-pills-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
      display: block;
    }

    .category-pills-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .category-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-decoration: none;
      height: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }

    .dark-mode .category-pill {
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .category-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      text-decoration: none;
    }

    .dark-mode .category-pill:hover { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35); }

    .category-pill.evidence {
      color: #10b981;
      border-color: rgba(16, 185, 129, 0.2);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04));
    }

    .dark-mode .category-pill.evidence {
      color: #34d399;
      border-color: rgba(52, 211, 153, 0.3);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.18), rgba(16, 185, 129, 0.1));
    }

    .category-pill.boundaries {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.2);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.04));
    }

    .dark-mode .category-pill.boundaries {
      color: #f87171;
      border-color: rgba(248, 113, 113, 0.3);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.18), rgba(239, 68, 68, 0.1));
    }

    .category-icon { font-size: 11px; opacity: 0.8; flex-shrink: 0; }

    /* ===========================
       CONTEXT & PRO TIPS SECTION
    =========================== */
    .context-tips-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 40px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto 50px;
      padding: 24px 20px 10px;
      margin-top: 6px;
    }

    .context-card, .tips-card {
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 28px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .dark-mode .context-card,
    .dark-mode .tips-card { box-shadow: 0 2px 8px rgba(0,0,0,0.22); }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .section-title i { color: var(--accent-purple); }

    .bullet-list { list-style: none; margin: 0; padding: 0; }

    .bullet-list li {
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
      padding-left: 26px;
      position: relative;
    }

    .bullet-list li::before {
      content: "•";
      position: absolute;
      left: 10px;
      color: var(--accent-purple);
      font-size: 18px;
    }

    /* ===========================
       CHECKLIST BODY
    =========================== */
    .checklist-body {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 20px;
    }

    .checklist-section-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 18px;
      margin-top: 60px !important;
    }

    .checklist-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .checklist-item {
      background: var(--primary-white);
      padding: 14px 16px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      height: 100%;
      min-height: 70px;
    }

    .dark-mode .checklist-item { box-shadow: 0 1px 4px rgba(0,0,0,0.14); }

    .checklist-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .dark-mode .checklist-item:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.28); }

    .checklist-item i {
      color: var(--accent-purple);
      font-size: 18px;
      margin-top: 3px;
      flex-shrink: 0;
    }

    .checklist-text {
      flex: 1;
      color: var(--text-medium);
      font-size: 15px;
      line-height: 1.5;
    }

    /* ===========================
       CAPACITY METER SECTION
    =========================== */
    .capacity-meter-section {
      max-width: 1100px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .capacity-header { margin-bottom: 18px; text-align: left; }

    .capacity-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }

    .capacity-header p {
      font-size: 14px;
      color: var(--text-medium);
      max-width: 1100px;
      line-height: 1.5;
    }

    .capacity-meter-container {
      display: flex;
      align-items: stretch;
      gap: 30px;
      background: var(--primary-white);
      border-radius: 16px;
      padding: 22px 24px 20px;
      box-shadow: 0 8px 30px rgba(123, 95, 196, 0.12);
      border: 1px solid rgba(123, 95, 196, 0.15);
    }

    .dark-mode .capacity-meter-container {
      box-shadow: 0 8px 30px rgba(123, 95, 196, 0.25);
      border: 1px solid rgba(123, 95, 196, 0.35);
    }

    .capacity-progress-container { flex: 1.4; }

    .capacity-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .capacity-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-purple-dark);
    }

    .capacity-status {
      font-size: 20px;
      font-weight: 800;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-green { background-color: rgba(16, 185, 129, 0.1); color: var(--capacity-green); border: 1px solid rgba(16, 185, 129, 0.2); }
    .status-yellow { background-color: rgba(245, 158, 11, 0.1); color: var(--capacity-yellow); border: 1px solid rgba(245, 158, 11, 0.2); }
    .status-red { background-color: rgba(239, 68, 68, 0.1); color: var(--capacity-red); border: 1px solid rgba(239, 68, 68, 0.2); }

    .capacity-meter {
      height: 10px;
      background: var(--light-gray);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 6px;
      position: relative;
    }

    .dark-mode .capacity-meter { background: rgba(255, 255, 255, 0.12); }

    .meter-fill {
      height: 100%;
      width: 0%;
      border-radius: 5px;
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .meter-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .meter-yellow { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .meter-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

    .meter-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--dark-gray);
    }

    .capacity-dimensions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .capacity-dimension-pill {
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      background: var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-medium);
    }

    .dark-mode .capacity-dimension-pill {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.1);
    }

    .capacity-dimension-pill span.label { font-weight: 600; color: var(--text-dark); }
    .capacity-dimension-pill span.score { font-weight: 700; color: var(--accent-purple); }

    .actions-container {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      max-width: 260px;
    }

    .action-btn {
      background: var(--premium-gradient);
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 13.5px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }

    .action-btn i { font-size: 14px; }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(123, 95, 196, 0.3);
    }

    .dark-mode .action-btn:hover { box-shadow: 0 8px 20px rgba(123, 95, 196, 0.4); }

    .action-btn.secondary { background: var(--light-purple); color: var(--accent-purple-dark); }

    .dark-mode .action-btn.secondary { background: rgba(123, 95, 196, 0.21); color: var(--accent-purple); }

    .action-btn.secondary:hover { background: var(--accent-purple); color: white; }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ===========================
       EVIDENCE WORKLOAD SECTION
    =========================== */
    .evidence-section {
      max-width: 1100px;
      margin: 0 auto 60px;
      padding: 0 20px;
      display: none;
    }

    .evidence-section.active {
      display: block;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evidence-header { text-align: center; margin-bottom: 28px; }

    .evidence-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }

    .evidence-subtitle { color: var(--text-medium); font-size: 16px; margin-bottom: 8px; }

    .evidence-insight {
      font-size: 14px;
      color: var(--dark-gray);
      max-width: 680px;
      margin: 0 auto;
    }

    .section-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-gray);
    }

    .section-header.red { color: var(--danger-red); }
    .section-header.purple { color: var(--accent-purple-dark); }
    .section-header.blue { color: var(--accent-purple); }

    .evidence-facts-grid,
    .conversation-grid,
    .boundary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .evidence-card {
      background: var(--primary-white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.08);
      border: 1px solid rgba(16, 185, 129, 0.1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .dark-mode .evidence-card {
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.18);
      border: 1px solid rgba(16, 185, 129, 0.22);
    }

    .evidence-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
    }

    .evidence-icon {
      font-size: 20px;
      color: var(--accent-purple);
      margin-bottom: 15px;
      width: 40px;
      height: 40px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark-mode .evidence-icon { background: rgba(16, 185, 129, 0.2); }

    .evidence-title-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .evidence-description {
      color: var(--text-medium);
      font-size: 14px;
      line-height: 1.5;
      flex-grow: 1;
    }

    .conversation-card {
      background: var(--primary-white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08);
      border: 1px solid rgba(123, 95, 196, 0.1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .dark-mode .conversation-card {
      box-shadow: 0 4px 12px rgba(123, 95, 196, 0.21);
      border: 1px solid rgba(123, 95, 196, 0.25);
    }

    .conversation-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
    }

    .conversation-icon {
      font-size: 20px;
      color: var(--accent-purple);
      margin-bottom: 15px;
      width: 40px;
      height: 40px;
      background: var(--lighter-purple);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark-mode .conversation-icon { background: rgba(123, 95, 196, 0.21); }

    .conversation-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .conversation-description {
      color: var(--text-medium);
      font-size: 14px;
      line-height: 1.5;
      flex-grow: 1;
    }

    .boundary-card {
      background: var(--primary-white);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08);
      border: 1px solid rgba(123, 95, 196, 0.1);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      transition: all 0.2s ease;
    }

    .dark-mode .boundary-card {
      box-shadow: 0 4px 12px rgba(123, 95, 196, 0.21);
      border: 1px solid rgba(123, 95, 196, 0.25);
    }

    .boundary-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(123, 95, 196, 0.16); }
    .dark-mode .boundary-card:hover { box-shadow: 0 8px 20px rgba(123, 95, 196, 0.25); }

    .boundary-card::before {
      content: '';
      position: absolute; top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
    }

    .boundary-icon {
      font-size: 20px;
      color: var(--accent-purple);
      margin-bottom: 15px;
      width: 40px;
      height: 40px;
      background: var(--lighter-purple);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark-mode .boundary-icon { background: rgba(123, 95, 196, 0.21); }

    .boundary-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .boundary-description {
      color: var(--text-medium);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 15px;
      flex-grow: 1;
    }

    .boundary-link {
      color: var(--accent-purple);
      font-weight: 600;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: auto;
    }

    .boundary-link:hover { text-decoration: underline; }

    /* ===========================
       MY PLAYBOOK FLOATING BUTTON + SIDEBAR
    =========================== */
    .my-playbook-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1200;
      background: var(--premium-gradient);
      color: #ffffff;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      transition: all 0.25s ease;
    }

    .my-playbook-fab i { font-size: 15px; }

    .my-playbook-fab:hover { transform: translateY(-3px); box-shadow: 0 14px 30px rgba(0,0,0,0.32); }

    .playbook-sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1190;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .playbook-sidebar-overlay.open { opacity: 1; pointer-events: auto; }

    .playbook-sidebar {
      position: fixed;
      top: 0;
      right: -380px;
      width: 340px;
      max-width: 90%;
      height: 100%;
      background: rgba(255, 255, 255, 0.94);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: -4px 0 20px rgba(0,0,0,0.25);
      z-index: 1191;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-light);
      transition: right 0.25s ease;
    }

    .dark-mode .playbook-sidebar {
      background: rgba(18, 18, 18, 0.96);
      box-shadow: -4px 0 22px rgba(0,0,0,0.6);
    }

    .playbook-sidebar.open { right: 0; }

    .playbook-sidebar-header {
      padding: 20px 20px 14px;
      border-bottom: 1px solid var(--border-light);
    }

    .playbook-sidebar-header-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .playbook-sidebar-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
    }

    .playbook-sidebar-header p { font-size: 13px; color: var(--dark-gray); }

    .playbook-close-btn {
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 18px;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .playbook-close-btn:hover { background: var(--light-gray); }

    .playbook-sidebar-body {
      padding: 14px 18px 20px;
      padding-bottom: 50px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .saved-items-empty {
      font-size: 13px;
      color: var(--dark-gray);
      line-height: 1.6;
    }

    .saved-items-list { list-style: none; margin: 0; padding: 0; }

    .saved-item {
      padding: 10px 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: var(--primary-white);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .saved-item-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .saved-item-title { font-size: 14px; font-weight: 600; color: var(--text-dark); }
    .saved-item-type { font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--accent-purple-dark); }
    .saved-item-meta { font-size: 12px; color: var(--dark-gray); }

    .saved-item-link {
      margin-top: 6px;
      font-size: 12px;
      color: var(--accent-purple);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .saved-item-link:hover { text-decoration: underline; }

    /* Quick links */
    .playbook-quick-links {
      margin-top: 223px;
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
    }

    .quick-links-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-medium);
    }

    .playbook-quick-links-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .quick-link-pill {
      width: 50%;
      padding: 4px 4px;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.35);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.08),rgba(123, 95, 196, 0.02));
      text-decoration: none;
      color: var(--accent-purple-dark);
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-link-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.16), rgba(123, 95, 196, 0.06));
    }

    .quick-link-pill i { font-size: 14px; }

    .dark-mode .quick-link-pill {
      border-color: rgba(157, 134, 233, 0.55);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.26),rgba(123, 95, 196, 0.12));
    }

    /* ===========================
       FOOTER
    =========================== */
    footer {
      background: var(--primary-white);
      padding: 10px 0;
      border-top: 1px solid var(--border-light);
      margin-top: 30px;
      text-align: center;
      color: var(--text-medium);
    }

    /* ===========================
       LOGIN / TIER MODAL (Premium gating)
    =========================== */
    .tep-modal-overlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .tep-modal-overlay.show { display: flex; }

    .tep-modal {
      width: 100%;
      max-width: 560px;
      background: rgba(255,255,255,0.94);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-radius: 16px;
      border: 1px solid var(--border-light);
      box-shadow: 0 18px 50px rgba(0,0,0,0.35);
      padding: 22px 22px 18px;
    }

    .dark-mode .tep-modal {
      background: rgba(18,18,18,0.95);
      border-color: rgba(255,255,255,0.10);
      box-shadow: 0 18px 60px rgba(0,0,0,0.60);
    }

    .tep-modal-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .tep-modal-sub {
      font-size: 13.5px;
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
    }

    .tep-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .tep-btn {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
      font-size: 13.5px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .tep-btn.primary {
      background: var(--premium-gradient);
      color: #fff;
      box-shadow: 0 8px 20px rgba(123,95,196,0.25);
    }

    .tep-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(123,95,196,0.32); }

    .tep-btn.ghost {
      background: var(--light-purple);
      color: var(--accent-purple-dark);
    }

    .dark-mode .tep-btn.ghost { background: rgba(123,95,196,0.21); color: var(--accent-purple); }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
      .context-tips-grid { grid-template-columns: 1fr; gap: 24px; }
      .evidence-facts-grid, .conversation-grid, .boundary-grid { grid-template-columns: repeat(2, 1fr); }
      .checklist-grid { grid-template-columns: 1fr; }
      .checklist-section-title { margin-top: 50px !important; }
      .capacity-meter-container { flex-direction: column; }
      .actions-container { max-width: 100%; flex-direction: row; }
    }

    @media (max-width: 768px) {
      .tool-hero-section { margin-top: 100px; }
      .context-tips-grid { padding: 20px 20px 10px; margin-top: 5px; }
      .context-card, .tips-card { padding: 24px; }
      .section-title { font-size: 18px; white-space: normal; }
      .hero-main-heading { font-size: 36px; }
      .hero-subheading { font-size: 16px; max-width: 100%; }
      .capacity-meter-container { padding: 18px 18px 18px; }
      .actions-container { flex-direction: column; align-items: stretch; }
      .evidence-facts-grid, .conversation-grid, .boundary-grid { grid-template-columns: 1fr; }
      .category-pills-grid { justify-content: flex-start; }
      .checklist-section-title { margin-top: 40px !important; }
      .save-btn { right: 18px; top: 10px; }
      .save-status { right: 105px; top: 10px; }
      .my-playbook-fab { bottom: 18px; right: 18px; }
    }

    @media (max-width: 480px) {
      .hero-main-heading { font-size: 32px; }
      .checklist-name { font-size: 18px; }
      .evidence-title { font-size: 22px; }
      .section-header { font-size: 18px; }
      .capacity-status { font-size: 16px; }
      .category-pill { font-size: 11px; padding: 5px 10px; height: 30px; }
      .checklist-item { padding: 12px 14px; min-height: 65px; }
      .checklist-text { font-size: 14px; }
      .checklist-section-title { margin-top: 30px !important; }
      .capacity-dimensions { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<!-- ===========================
     NAVIGATION
=========================== -->
<nav>
  <div class="container nav-container">
    <button class="mobile-toggle"><i class="fas fa-bars"></i></button>

    <a href="index.html" class="logo">
      <img src="./assets/img/logo.png" alt="The Employee Playbook" class="logo-img" id="mainLogo">
    </a>

    <div class="nav-links">
      <a href="the-lens.html" class="nav-link">The Lens</a>
      <a href="the-toolkit.html" class="nav-link">The Toolkit</a>
      <div class="nav-link-container">
        <a href="the-coach.html" class="nav-link">The Coach</a>
        <span class="new-tag">NEW</span>
      </div>
      <a href="the-shift.html" class="nav-link">The Shift</a>
      <a href="the-pricing.html" class="nav-link">The Pricing</a>
      <a href="sign-in.html" class="mobile-sign-in">Sign In</a>
      <a href="create-account.html" class="mobile-sign-up">Sign Up</a>
    </div>

    <div class="nav-actions" id="navActions">
      <!-- Will be swapped to Sign out + My Account after auth, but we keep your layout by default -->
      <a href="create-account.html" class="header-cta" id="navSignUp">Sign up</a>
      <a href="sign-in.html" class="sign-in" id="navSignIn">Sign in</a>
      <button class="theme-toggle" id="themeToggleBtn"><i class="fas fa-moon"></i></button>
    </div>
  </div>
</nav>

<!-- ===========================
     ENHANCED HERO SECTION
=========================== -->
<div class="tool-hero-section">
  <!-- Save status (progress autosave feedback) -->
  <div class="save-status" id="saveStatusChip">
    <i class="fas fa-cloud"></i>
    <span id="saveStatusText">Checking…</span>
  </div>

  <!-- Save tool to My Playbook (cross-device) -->
  <button class="save-btn" id="saveBtn">
    <i class="far fa-bookmark"></i>
    <span>Save item</span>
  </button>

  <div class="tool-hero-content">
    <div class="breadcrumb">
      <a href="the-toolkit.html">Toolkit</a>
      <i class="fas fa-chevron-right"></i>
      <a href="workload-boundaries-and-capacity.html">Workload, Boundaries & Capacity</a>
      <i class="fas fa-chevron-right"></i>
      <span class="current">Capacity Checklist</span>
    </div>

    <span class="checklist-name">CAPACITY CHECKLIST</span>

    <h1 class="hero-main-heading">Facts Over Feelings → Workload Evidence</h1>

    <div class="hero-subheading">
      When you're overwhelmed or feel at capacity, use this tool to move from subjective feelings to objective evidence.
      Collect concrete data about your actual workload to have better conversations about priorities, deadlines, and what's truly possible.
    </div>

    <div class="category-pills-container">
      <span class="category-pills-title">Explore Categories</span>

      <div class="category-pills-grid">
        <a href="evidence-based-conversations.html" class="category-pill evidence">
          <i class="fas fa-chart-bar category-icon"></i>
          <span>Evidence-Based Conversations</span>
        </a>

        <a href="boundary-setting-and-advocacy.html" class="category-pill boundaries">
          <i class="fas fa-shield-alt category-icon"></i>
          <span>Boundary Setting & Advocacy</span>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ===========================
     CONTEXT & PRO TIPS SECTION
=========================== -->
<div class="context-tips-grid">
  <div class="context-card">
    <h3 class="section-title"><i class="fas fa-calendar-check"></i>When to Use This Checklist</h3>
    <ul class="bullet-list">
      <li>When you feel constantly overwhelmed or at capacity</li>
      <li>Before having a conversation with your manager about workload</li>
      <li>When you're being asked to take on additional responsibilities</li>
      <li>When you need to push back on unrealistic deadlines or expectations</li>
      <li>When you suspect your actual workload doesn't match your role or level</li>
      <li>When planning for the next quarter or performance review</li>
    </ul>
  </div>

  <div class="tips-card">
    <h3 class="section-title"><i class="fas fa-lightbulb"></i>Pro Tips</h3>
    <ul class="bullet-list">
      <li>Track your actual time for 1-2 weeks for the most accurate data</li>
      <li>Include meetings, email, and "invisible work" in your calculations</li>
      <li>Be specific with your evidence - numbers are more persuasive than feelings</li>
      <li>Use this as a collaborative tool, not a weapon against your manager</li>
      <li>Focus on solutions, not just problems - bring options to the conversation</li>
      <li>Update this regularly as your role and responsibilities evolve</li>
    </ul>
  </div>
</div>

<!-- ===========================
     CHECKLIST BODY CONTENT
=========================== -->
<div class="checklist-body" id="checklistText">
  <h2 class="checklist-section-title">Your Capacity Checklist</h2>

  <div class="checklist-grid">
    <div class="checklist-item" data-category="tracking">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've tracked my actual time spent on different types of work for at least one full week.</div>
    </div>
    <div class="checklist-item" data-category="hours">
      <i class="far fa-square"></i>
      <div class="checklist-text">I know how many hours I'm actually working each week (not just "feels like" a lot).</div>
    </div>
    <div class="checklist-item" data-category="meetings">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've calculated what percentage of my week is spent in meetings versus focused work.</div>
    </div>
    <div class="checklist-item" data-category="invisible">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've accounted for "invisible work" - emails, quick questions, administrative tasks, context switching.</div>
    </div>
    <div class="checklist-item" data-category="scope">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've documented all my current responsibilities and projects with estimated time requirements.</div>
    </div>
    <div class="checklist-item" data-category="comparison">
      <i class="far fa-square"></i>
      <div class="checklist-text">I can compare my current workload to my job description or role expectations.</div>
    </div>
    <div class="checklist-item" data-category="sustainability">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've assessed whether my current workload is sustainable long-term without burnout.</div>
    </div>
    <div class="checklist-item" data-category="growth">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've identified what percentage of my time is spent on growth vs maintenance work.</div>
    </div>
    <div class="checklist-item" data-category="priority-time">
      <i class="far fa-square"></i>
      <div class="checklist-text">I know how much time I actually have for priority work versus reactive work.</div>
    </div>
    <div class="checklist-item" data-category="buffer">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've calculated what buffer I have for unexpected work or emergencies.</div>
    </div>
    <div class="checklist-item" data-category="data-visual">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've created a visual (chart, graph, or simple summary) of my workload distribution.</div>
    </div>
    <div class="checklist-item" data-category="options">
      <i class="far fa-square"></i>
      <div class="checklist-text">I've identified what could be deprioritised, delegated, or done differently to create capacity.</div>
    </div>
  </div>
</div>

<!-- ===========================
     CAPACITY METER SECTION
=========================== -->
<div class="capacity-meter-section">
  <div class="capacity-header">
    <h2>Your Capacity Scorer</h2>
    <p>
      Your Capacity Score shows how well you understand your actual workload versus perceived workload.
      High scores mean you have strong evidence about your capacity; low scores indicate you're operating
      on feelings rather than facts. Use this to build evidence for workload conversations.
    </p>
  </div>

  <div class="capacity-meter-container">
    <div class="capacity-progress-container">
      <div class="capacity-title-row">
        <div class="capacity-title">Capacity Evidence Score</div>
        <div class="capacity-status" id="capacityStatus">Gathering Data</div>
      </div>
      <div class="capacity-meter">
        <div class="meter-fill" id="meterFill"></div>
      </div>
      <div class="meter-labels">
        <span>Operating on Feelings</span>
        <span>Some Evidence</span>
        <span>Strong Evidence Base</span>
      </div>

      <div class="capacity-dimensions">
        <div class="capacity-dimension-pill">
          <span class="label">Time Tracking</span>
          <span class="score" id="scoreTracking">0%</span>
        </div>
        <div class="capacity-dimension-pill">
          <span class="label">Workload Analysis</span>
          <span class="score" id="scoreAnalysis">0%</span>
        </div>
        <div class="capacity-dimension-pill">
          <span class="label">Evidence Quality</span>
          <span class="score" id="scoreEvidence">0%</span>
        </div>
        <div class="capacity-dimension-pill">
          <span class="label">Solution Thinking</span>
          <span class="score" id="scoreSolutions">0%</span>
        </div>
      </div>
    </div>

    <div class="actions-container">
      <button class="action-btn" id="generateBtn" disabled>
        <i class="fas fa-chart-bar"></i> Generate Evidence Report
      </button>
      <button class="action-btn secondary" id="copyBtn">
        <i class="far fa-copy"></i> Copy Checklist
      </button>
    </div>
  </div>
</div>

<!-- ===========================
     EVIDENCE WORKLOAD SECTION
=========================== -->
<div class="evidence-section" id="evidenceSummary">
  <div class="evidence-header">
    <h2 class="evidence-title">Your Workload Evidence Report</h2>
    <p class="evidence-subtitle">Based on your Capacity Evidence Score of <span id="summaryScore">0%</span> • Status: <span id="summaryStatus">Gathering Data</span></p>
    <p class="evidence-insight">
      This report transforms feelings into facts. Use it to have evidence-based conversations about workload,
      priorities, and realistic expectations. Numbers are more persuasive than emotions.
    </p>
  </div>

  <h3 class="section-header purple"><i class="fas fa-chart-pie"></i> Key Workload Evidence</h3>
  <div class="evidence-facts-grid" id="evidenceFactsGrid"></div>

  <h3 class="section-header blue"><i class="fas fa-comments"></i> Conversation Starters</h3>
  <div class="conversation-grid" id="conversationGrid"></div>

  <h3 class="section-header purple"><i class="fas fa-tools"></i> Capacity Building Strategies</h3>
  <div class="boundary-grid" id="boundaryGrid"></div>
</div>

<!-- ===========================
     MY PLAYBOOK SIDEBAR
=========================== -->
<div class="playbook-sidebar-overlay" id="playbookOverlay">
  <div class="playbook-sidebar" id="playbookSidebar">
    <div class="playbook-sidebar-header">
      <div class="playbook-sidebar-header-title-row">
        <h3>My Playbook</h3>
        <button class="playbook-close-btn" id="closePlaybook" aria-label="Close My Playbook">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <p>Saved items</p>
    </div>

    <div class="playbook-sidebar-body">
      <div id="savedItemsContainer">
        <p class="saved-items-empty" id="savedItemsEmpty">
          You haven't saved anything yet. Use <strong>Save item</strong> on tools you want quick access to.
        </p>
        <ul class="saved-items-list" id="savedItemsList"></ul>
      </div>

      <div class="playbook-quick-links">
        <div class="playbook-quick-links-header">
          <span class="quick-links-title">Quick links</span>
        </div>
        <div class="playbook-quick-links-list">
          <a href="dashboard.html" class="quick-link-pill">
            <i class="fas fa-gauge"></i> The Dashboard
          </a>
          <a href="the-lens.html" class="quick-link-pill">
            <i class="fas fa-search"></i> The Lens
          </a>
          <a href="the-toolkit.html" class="quick-link-pill">
            <i class="fas fa-toolbox"></i> The Toolkit
          </a>
          <a href="the-coach.html" class="quick-link-pill">
            <i class="fas fa-comments"></i> The Coach
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="my-playbook-fab" id="myPlaybookButton">
  <i class="fas fa-book-open"></i>
  <span>My Playbook</span>
</div>

<!-- ===========================
     FOOTER
=========================== -->
<footer>
  <div class="container">
    <p>© 2025 The Employee Playbook. All rights reserved.</p>
  </div>
</footer>

<!-- ===========================
     AUTH / TIER MODAL
=========================== -->
<div class="tep-modal-overlay" id="authModal">
  <div class="tep-modal">
    <div class="tep-modal-title">
      <i class="fas fa-lock"></i>
      <span id="authModalTitle">Sign in required</span>
    </div>
    <div class="tep-modal-sub" id="authModalBody">
      This tool is available behind login. Please sign in to continue.
    </div>
    <div class="tep-modal-actions">
      <a class="tep-btn ghost" href="the-pricing.html">
        <i class="fas fa-gem"></i> View plans
      </a>
      <a class="tep-btn primary" href="sign-in.html" id="authModalSignIn">
        <i class="fas fa-right-to-bracket"></i> Sign in
      </a>
    </div>
  </div>
</div>

<!-- ===========================
     JAVASCRIPT (Supabase + Tool)
=========================== -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  /* =========================================================
     0) CONFIG — set these
  ========================================================= */
  const SUPABASE_URL = "PASTE_YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY";

  // Tool identity (must be stable across devices for saving)
  const TOOL_SLUG = "checklist-capacity";
  const TOOL_TITLE = "Capacity Checklist";
  const TOOL_TYPE = "tool";

  // Optional tier gating:
  // - Set to "core" or "edge" if you want to block lower tiers.
  // - This code attempts to read a tier from a "profiles" table (membership_tier).
  // - If you don't have that yet, leave REQUIRED_TIER = null (allows access).
  const REQUIRED_TIER = null; // "core" | "edge" | null

  // Supabase tables (we will create these next)
  const TABLE_PROGRESS = "tep_tool_progress";
  const TABLE_SAVED = "tep_saved_items";

  // Versioning for your saved payloads (lets you migrate later)
  const TOOL_DATA_VERSION = 1;

  // Local fallback cache (per-user)
  const LS_CACHE_PREFIX = "TEP_TOOL_CACHE_V1"; // keep stable

  /* =========================================================
     1) STATE
  ========================================================= */
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });

  let currentUser = null;
  let currentTier = "unknown";

  let checkedItems = [];
  let itemCategories = [];

  const dimensionConfig = {
    tracking: ['tracking', 'hours', 'meetings'],
    analysis: ['invisible', 'scope', 'comparison', 'sustainability'],
    evidence: ['growth', 'priority-time', 'buffer', 'data-visual'],
    solutions: ['options']
  };

  // Save debouncing
  let saveTimer = null;
  let lastSavedAt = null;
  let lastSaveSource = "cloud"; // cloud | local
  let inFlightSave = false;

  /* =========================================================
     2) DOM READY
  ========================================================= */
  document.addEventListener("DOMContentLoaded", async () => {
    document.body.classList.add("loaded");

    // Core UI init (safe even before auth)
    initializeMobileNav();
    initializeThemeToggle();
    initializeChecklistUI();
    wireButtons();
    initializePlaybookUI();

    // Auth gate + load user + tier (missing thing #1)
    await requireAuth();

    // Replace nav actions (optional polish)
    updateNavForAuth();

    // Tier enforcement (missing thing #1, part 2)
    const tierOk = await enforceTierIfNeeded();
    if (!tierOk) return;

    // Load saved items (cross-device) + progress (missing thing #2 + #3)
    await hydrateSavedItems();
    await hydrateToolProgress();

    // Show initial save status
    setSaveStatus("good", "Ready • autosave on", true);

    // Keep page in sync if auth changes (sign out in another tab etc.)
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (!session?.user) {
        // If they lose session, block the tool
        showAuthModal("Session ended", "Please sign in again to continue. Your latest work is safe if it was saved.");
        return;
      }
      currentUser = session.user;
      updateNavForAuth();
      await hydrateSavedItems();
      await hydrateToolProgress();
    });

    // Offline/online awareness (missing thing #4)
    window.addEventListener("offline", () => setSaveStatus("warn", "Offline • saving locally", true));
    window.addEventListener("online",  () => setSaveStatus("good", "Back online • syncing", true));
  });

  /* =========================================================
     3) AUTH GATE (Required)
  ========================================================= */
  async function requireAuth() {
    try {
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;

      const user = data?.session?.user;
      if (!user) {
        showAuthModal("Sign in required", "This tool is available behind login. Please sign in to continue.");
        throw new Error("No active session");
      }

      currentUser = user;
      return true;
    } catch (e) {
      // Modal already shown. Stop further initialisation.
      console.warn("Auth gate blocked:", e?.message || e);
      return false;
    }
  }

  async function enforceTierIfNeeded() {
    if (!REQUIRED_TIER) return true;

    // Attempt to read from a profiles table (optional, non-blocking if missing)
    // Expected: public.profiles has columns: id (uuid) and membership_tier (text: free/core/edge)
    // If you use a different table/column, we can adjust.
    currentTier = await getUserTier();

    const ok = tierSatisfies(currentTier, REQUIRED_TIER);
    if (!ok) {
      showAuthModal(
        "Upgrade required",
        `This tool is part of the <strong>${REQUIRED_TIER.toUpperCase()}</strong> plan. Upgrade to unlock it across all devices.`
      );
      return false;
    }
    return true;
  }

  function tierSatisfies(userTier, requiredTier) {
    const order = { free: 0, core: 1, edge: 2, unknown: 0 };
    return (order[userTier] ?? 0) >= (order[requiredTier] ?? 999);
  }

  async function getUserTier() {
    try {
      // If you don’t have a profiles table yet, this will fail gracefully.
      const { data, error } = await supabase
        .from("profiles")
        .select("membership_tier")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (error) throw error;
      const tier = (data?.membership_tier || "unknown").toLowerCase();
      return tier;
    } catch (e) {
      return "unknown";
    }
  }

  function showAuthModal(title, bodyHtml) {
    const overlay = document.getElementById("authModal");
    const t = document.getElementById("authModalTitle");
    const b = document.getElementById("authModalBody");
    if (t) t.textContent = title;
    if (b) b.innerHTML = bodyHtml;
    if (overlay) overlay.classList.add("show");
  }

  /* =========================================================
     4) NAV POLISH (optional but tidy)
  ========================================================= */
  function updateNavForAuth() {
    const signIn = document.getElementById("navSignIn");
    const signUp = document.getElementById("navSignUp");
    const navActions = document.getElementById("navActions");

    if (!navActions) return;

    // Keep theme toggle where it is. We’ll swap links to prevent confusion.
    if (currentUser) {
      if (signIn) { signIn.textContent = "Sign out"; signIn.href = "#"; }
      if (signUp) { signUp.textContent = "My account"; signUp.href = "dashboard.html"; }

      if (signIn) {
        signIn.onclick = async (e) => {
          e.preventDefault();
          try {
            setSaveStatus("warn", "Signing out…", true);
            await supabase.auth.signOut();
            // Redirect after sign-out
            window.location.href = "sign-in.html";
          } catch (err) {
            console.warn(err);
            setSaveStatus("bad", "Sign out failed", true);
          }
        };
      }
    }
  }

  /* =========================================================
     5) TOOL UI INIT
  ========================================================= */
  function wireButtons() {
    const genBtn = document.getElementById("generateBtn");
    const copyBtn = document.getElementById("copyBtn");
    const saveBtn = document.getElementById("saveBtn");

    if (genBtn) genBtn.addEventListener("click", () => generateEvidenceSummary());
    if (copyBtn) copyBtn.addEventListener("click", () => copyChecklist());

    if (saveBtn) {
      saveBtn.addEventListener("click", async () => {
        await toggleSaveTool();
      });
    }
  }

  function initializeChecklistUI() {
    const checklistContainers = document.querySelectorAll(".checklist-item");
    checkedItems = new Array(checklistContainers.length).fill(false);
    itemCategories = [];

    checklistContainers.forEach((container, index) => {
      const icon = container.querySelector("i");
      const category = container.getAttribute("data-category") || "";
      itemCategories[index] = category;

      container.addEventListener("click", () => {
        if (!icon) return;

        const nowChecked = !checkedItems[index];
        checkedItems[index] = nowChecked;

        if (nowChecked) {
          icon.classList.remove("fa-square");
          icon.classList.add("fa-check-square");
          icon.style.color = "#5A4496";
        } else {
          icon.classList.remove("fa-check-square");
          icon.classList.add("fa-square");
          icon.style.color = "#7B5FC4";
        }

        updateCapacityScore();

        // Autosave (missing thing #3)
        queueProgressSave("change");
      });
    });

    updateCapacityScore();
  }

  function applyChecklistState(state) {
    // state.checkedItems is boolean[]
    const items = document.querySelectorAll(".checklist-item");
    const arr = Array.isArray(state?.checkedItems) ? state.checkedItems : null;
    if (!arr || arr.length !== items.length) return;

    checkedItems = arr.slice(0, items.length);

    items.forEach((container, idx) => {
      const icon = container.querySelector("i");
      if (!icon) return;

      icon.classList.remove("fa-square", "fa-check-square");
      if (checkedItems[idx]) {
        icon.classList.add("fa-check-square");
        icon.style.color = "#5A4496";
      } else {
        icon.classList.add("fa-square");
        icon.style.color = "#7B5FC4";
      }
    });

    updateCapacityScore();

    if (state?.reportGenerated) {
      document.getElementById("evidenceSummary")?.classList.add("active");
      // Regenerate for consistent content (fast + deterministic)
      generateEvidenceFacts();
      const score = computeCapacityScore();
      generateConversationStarters(score);
      generateCapacityStrategies();
    }
  }

  /* =========================================================
     6) SCORING
  ========================================================= */
  function computeCapacityScore() {
    const checkedCount = checkedItems.filter(Boolean).length;
    const totalCount = checkedItems.length;
    return totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;
  }

  function computeDimensionScores() {
    const dimensionScores = {
      tracking: { checked: 0, total: 0 },
      analysis: { checked: 0, total: 0 },
      evidence: { checked: 0, total: 0 },
      solutions: { checked: 0, total: 0 }
    };

    itemCategories.forEach((category, index) => {
      Object.keys(dimensionConfig).forEach(dim => {
        if (dimensionConfig[dim].includes(category)) {
          dimensionScores[dim].total += 1;
          if (checkedItems[index]) dimensionScores[dim].checked += 1;
        }
      });
    });

    const pct = (obj) => obj.total ? Math.round((obj.checked / obj.total) * 100) : 0;

    return {
      tracking: pct(dimensionScores.tracking),
      analysis: pct(dimensionScores.analysis),
      evidence: pct(dimensionScores.evidence),
      solutions: pct(dimensionScores.solutions),
    };
  }

  function updateCapacityScore() {
    const checkedCount = checkedItems.filter(Boolean).length;
    const totalCount = checkedItems.length;
    const capacityScore = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

    const meterFill = document.getElementById("meterFill");
    const capacityStatus = document.getElementById("capacityStatus");

    if (meterFill) meterFill.style.width = capacityScore + "%";

    if (meterFill) meterFill.classList.remove("meter-green", "meter-yellow", "meter-red");
    if (capacityStatus) capacityStatus.classList.remove("status-green", "status-yellow", "status-red");

    if (capacityScore >= 75) {
      meterFill?.classList.add("meter-green");
      capacityStatus?.classList.add("status-green");
      if (capacityStatus) capacityStatus.textContent = "Strong Evidence";
    } else if (capacityScore >= 40) {
      meterFill?.classList.add("meter-yellow");
      capacityStatus?.classList.add("status-yellow");
      if (capacityStatus) capacityStatus.textContent = "Moderate Evidence";
    } else {
      meterFill?.classList.add("meter-red");
      capacityStatus?.classList.add("status-red");
      if (capacityStatus) capacityStatus.textContent = "Gathering Data";
    }

    const genBtn = document.getElementById("generateBtn");
    if (genBtn) genBtn.disabled = checkedCount === 0;

    const dims = computeDimensionScores();
    document.getElementById("scoreTracking").textContent = dims.tracking + "%";
    document.getElementById("scoreAnalysis").textContent  = dims.analysis + "%";
    document.getElementById("scoreEvidence").textContent  = dims.evidence + "%";
    document.getElementById("scoreSolutions").textContent = dims.solutions + "%";
  }

  /* =========================================================
     7) EVIDENCE REPORT
  ========================================================= */
  function generateEvidenceSummary() {
    const capacityScore = computeCapacityScore();

    document.getElementById("summaryScore").textContent = capacityScore + "%";

    let statusText = "Gathering Data";
    if (capacityScore >= 75) statusText = "Strong Evidence";
    else if (capacityScore >= 40) statusText = "Moderate Evidence";
    document.getElementById("summaryStatus").textContent = statusText;

    document.getElementById("evidenceSummary")?.classList.add("active");
    document.getElementById("evidenceSummary")?.scrollIntoView({ behavior: "smooth" });

    generateEvidenceFacts();
    generateConversationStarters(capacityScore);
    generateCapacityStrategies();

    // Save that report has been generated (missing thing #3)
    queueProgressSave("report");
  }

  function generateEvidenceFacts() {
    const evidenceFactsGrid = document.getElementById("evidenceFactsGrid");
    if (!evidenceFactsGrid) return;
    evidenceFactsGrid.innerHTML = "";

    const evidenceFacts = [];

    if (checkedItems[0]) {
      evidenceFacts.push({
        title: "Actual Time Data",
        description: "You have concrete data on how you spend your time, which is the foundation for evidence-based conversations.",
        icon: "fas fa-clock"
      });
    }
    if (checkedItems[1]) {
      evidenceFacts.push({
        title: "Real Hours Worked",
        description: "You know your actual weekly hours, not just perceived workload. This helps identify overtime or unsustainable patterns.",
        icon: "fas fa-business-time"
      });
    }
    if (checkedItems[2]) {
      evidenceFacts.push({
        title: "Meeting vs Focus Balance",
        description: "You understand your meeting-to-focus ratio, a key factor in productivity and capacity management.",
        icon: "fas fa-chart-pie"
      });
    }
    if (checkedItems[3]) {
      evidenceFacts.push({
        title: "Invisible Work Accounted",
        description: "You've quantified the 'invisible' tasks that often get overlooked but consume significant time.",
        icon: "fas fa-eye-slash"
      });
    }
    if (checkedItems[4]) {
      evidenceFacts.push({
        title: "Documented Responsibilities",
        description: "You have a written record of all current responsibilities with time estimates, creating clarity about scope.",
        icon: "fas fa-list-check"
      });
    }
    if (checkedItems[5]) {
      evidenceFacts.push({
        title: "Role Alignment Analysis",
        description: "You can compare actual workload to role expectations, highlighting potential misalignment.",
        icon: "fas fa-balance-scale"
      });
    }

    const checkedCount = checkedItems.filter(Boolean).length;
    if (checkedCount >= 3 && evidenceFacts.length === 0) {
      evidenceFacts.push({
        title: "Multiple Data Points",
        description: "You have collected multiple types of workload data, strengthening your evidence base.",
        icon: "fas fa-database"
      });
    }

    if (evidenceFacts.length === 0) {
      evidenceFacts.push({
        title: "Starting the Process",
        description: "You're beginning to gather evidence about your workload. Focus on tracking time for one week.",
        icon: "fas fa-flag"
      });
    }

    while (evidenceFacts.length < 3) {
      if (evidenceFacts.length === 1) {
        evidenceFacts.push({
          title: "Workload Patterns",
          description: "Tracking reveals patterns in how work accumulates and when you're most productive.",
          icon: "fas fa-chart-line"
        });
      } else {
        evidenceFacts.push({
          title: "Capacity Insights",
          description: "Evidence shows where time is well-spent versus where it might be wasted or misallocated.",
          icon: "fas fa-lightbulb"
        });
      }
    }

    evidenceFacts.slice(0, 3).forEach((fact) => {
      const card = document.createElement("div");
      card.className = "evidence-card";
      card.innerHTML = `
        <div class="evidence-icon"><i class="${fact.icon}"></i></div>
        <h4 class="evidence-title-text">${escapeHtml(fact.title)}</h4>
        <p class="evidence-description">${escapeHtml(fact.description)}</p>
      `;
      evidenceFactsGrid.appendChild(card);
    });
  }

  function generateConversationStarters(capacityScore) {
    const conversationGrid = document.getElementById("conversationGrid");
    if (!conversationGrid) return;
    conversationGrid.innerHTML = "";

    let starters = [];

    if (capacityScore >= 75) {
      starters = [
        {
          title: "Data-Driven Prioritisation",
          description: `"Based on my time tracking, I'm spending X hours on Y. Let's discuss if this aligns with our priorities."`,
          icon: "fas fa-chart-bar"
        },
        {
          title: "Sustainable Workload",
          description: `"My data shows I'm working X hours weekly. Can we discuss ensuring this remains sustainable long-term?"`,
          icon: "fas fa-heartbeat"
        },
        {
          title: "Growth vs Maintenance",
          description: `"Only Y% of my time is on growth work. How can we increase this to support my development and team goals?"`,
          icon: "fas fa-seedling"
        }
      ];
    } else if (capacityScore >= 40) {
      starters = [
        {
          title: "Initial Workload Review",
          description: `"I've started tracking my time and notice some patterns. Can we review my current responsibilities?"`,
          icon: "fas fa-clipboard-check"
        },
        {
          title: "Meeting Time Impact",
          description: `"Meetings are taking up X% of my week. Can we discuss which are essential for my role?"`,
          icon: "fas fa-users"
        },
        {
          title: "Scope Clarification",
          description: `"I want to ensure I'm focused on the right things. Can we align on my top 3 priorities for this quarter?"`,
          icon: "fas fa-bullseye"
        }
      ];
    } else {
      starters = [
        {
          title: "Starting the Conversation",
          description: `"I want to better understand my capacity. Can we discuss my current workload and priorities?"`,
          icon: "fas fa-comment"
        },
        {
          title: "Workload Assessment",
          description: `"I feel at capacity. Can we review what's on my plate and identify what might be deprioritised?"`,
          icon: "fas fa-tasks"
        },
        {
          title: "Time Tracking Plan",
          description: `"I plan to track my time for a week to get clearer data. Can we then discuss what the data shows?"`,
          icon: "fas fa-calendar-plus"
        }
      ];
    }

    starters.forEach((starter) => {
      const card = document.createElement("div");
      card.className = "conversation-card";
      card.innerHTML = `
        <div class="conversation-icon"><i class="${starter.icon}"></i></div>
        <h4 class="conversation-title">${escapeHtml(starter.title)}</h4>
        <p class="conversation-description">${escapeHtml(starter.description)}</p>
      `;
      conversationGrid.appendChild(card);
    });
  }

  function generateCapacityStrategies() {
    const boundaryGrid = document.getElementById("boundaryGrid");
    if (!boundaryGrid) return;
    boundaryGrid.innerHTML = "";

    const uncheckedCategories = {};
    checkedItems.forEach((checked, index) => {
      if (!checked) {
        const category = itemCategories[index];
        uncheckedCategories[category] = (uncheckedCategories[category] || 0) + 1;
      }
    });

    let strategies = [];

    strategies.push({
      title: "One-Week Time Audit",
      description: "Use a simple spreadsheet or time tracking app to log all work for 7 days. Categorise by project, meeting type, and task type.",
      icon: "fas fa-stopwatch"
    });

    if (uncheckedCategories["meetings"]) {
      strategies.push({
        title: "Meeting Effectiveness Review",
        description: "Evaluate which meetings are essential, which could be emails, and which you could attend less frequently.",
        icon: "fas fa-user-clock"
      });
    } else {
      strategies.push({
        title: "Protected Focus Time",
        description: "Block 2–3 hours daily for deep work. Treat this time as non-negotiable for priority projects.",
        icon: "fas fa-lock"
      });
    }

    if (uncheckedCategories["options"]) {
      strategies.push({
        title: "Delegation Opportunities",
        description: "Identify tasks that could be delegated to junior team members or automated with tools.",
        icon: "fas fa-people-arrows"
      });
    } else {
      strategies.push({
        title: "Quarterly Workload Review",
        description: "Schedule a quarterly review of all responsibilities with your manager to ensure alignment.",
        icon: "fas fa-calendar-alt"
      });
    }

    strategies.slice(0, 3).forEach(strategy => {
      const card = document.createElement("div");
      card.className = "boundary-card";
      card.innerHTML = `
        <div class="boundary-icon"><i class="${strategy.icon}"></i></div>
        <h4 class="boundary-title">${escapeHtml(strategy.title)}</h4>
        <p class="boundary-description">${escapeHtml(strategy.description)}</p>
        <a href="#" class="boundary-link" onclick="return false;">Learn More <i class="fas fa-arrow-right"></i></a>
      `;
      boundaryGrid.appendChild(card);
    });
  }

  /* =========================================================
     8) COPY
  ========================================================= */
  async function copyChecklist() {
    const checklistName = "CAPACITY CHECKLIST";
    const mainHeading = document.querySelector(".hero-main-heading")?.textContent || "";
    const checklistTexts = document.querySelectorAll(".checklist-text");

    let text = `${checklistName}\n`;
    text += `=============================\n\n`;
    text += `${mainHeading}\n\n`;
    text += `CAPACITY CHECKLIST:\n`;
    text += `===================\n\n`;

    checklistTexts.forEach((item, index) => {
      const isChecked = checkedItems[index] ? "[✓]" : "[ ]";
      text += `${isChecked} ${index + 1}. ${item.innerText}\n`;
    });

    const checkedCount = checkedItems.filter(Boolean).length;
    if (checkedCount > 0) {
      const capacityScore = computeCapacityScore();
      let status = "Gathering Data";
      if (capacityScore >= 75) status = "Strong Evidence";
      else if (capacityScore >= 40) status = "Moderate Evidence";

      text += `\nCURRENT STATUS:\n`;
      text += `===============\n`;
      text += `Items checked: ${checkedCount}/${checklistTexts.length}\n`;
      text += `Capacity Evidence Score: ${capacityScore}%\n`;
      text += `Status: ${status}\n`;
    }

    try {
      await navigator.clipboard.writeText(text);
      const btn = document.getElementById("copyBtn");
      if (!btn) return;
      const originalHTML = btn.innerHTML;
      const originalBg = btn.style.background;

      btn.innerHTML = '<i class="fas fa-check"></i> Checklist Copied!';
      btn.style.background = "#10b981";

      setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.background = originalBg;
      }, 2000);
    } catch (e) {
      setSaveStatus("bad", "Copy failed • browser blocked clipboard", true);
    }
  }

  /* =========================================================
     9) MY PLAYBOOK — CROSS DEVICE (Supabase) + Local fallback
     Missing thing #2
  ========================================================= */
  function initializePlaybookUI() {
    const playbookOverlay = document.getElementById("playbookOverlay");
    const playbookSidebar = document.getElementById("playbookSidebar");
    const playbookButton = document.getElementById("myPlaybookButton");
    const closeBtn = document.getElementById("closePlaybook");

    if (!playbookOverlay || !playbookSidebar || !playbookButton || !closeBtn) return;

    playbookButton.addEventListener("click", () => {
      playbookOverlay.classList.add("open");
      playbookSidebar.classList.add("open");
    });

    closeBtn.addEventListener("click", () => {
      playbookOverlay.classList.remove("open");
      playbookSidebar.classList.remove("open");
    });

    playbookOverlay.addEventListener("click", (e) => {
      if (e.target === playbookOverlay) {
        playbookOverlay.classList.remove("open");
        playbookSidebar.classList.remove("open");
      }
    });
  }

  async function hydrateSavedItems() {
    // If no user, do nothing
    if (!currentUser) return;

    // 1) Try Supabase first
    const cloud = await fetchSavedItemsFromCloud().catch(() => null);

    if (cloud && Array.isArray(cloud)) {
      renderSavedItems(cloud);
      const saved = cloud.some(x => x.tool_slug === TOOL_SLUG);
      updateSaveButtonState(saved);
      // keep local mirror
      writeLocalSavedItems(cloud);
      return;
    }

    // 2) Fallback to local
    const local = readLocalSavedItems();
    renderSavedItems(local);
    const saved = local.some(x => x.tool_slug === TOOL_SLUG);
    updateSaveButtonState(saved);

    // UI feedback
    if (!navigator.onLine) setSaveStatus("warn", "Offline • using local Playbook", true);
  }

  async function fetchSavedItemsFromCloud() {
    const { data, error } = await supabase
      .from(TABLE_SAVED)
      .select("tool_slug,title,item_type,link,saved_at")
      .eq("user_id", currentUser.id)
      .order("saved_at", { ascending: false });

    // If table doesn't exist yet, this will error—handle gracefully.
    if (error) throw error;
    return data || [];
  }

  function writeLocalSavedItems(items) {
    try {
      const key = `${LS_CACHE_PREFIX}:saved_items:${currentUser.id}`;
      localStorage.setItem(key, JSON.stringify(items));
    } catch (e) {}
  }

  function readLocalSavedItems() {
    try {
      const key = `${LS_CACHE_PREFIX}:saved_items:${currentUser?.id || "anon"}`;
      const raw = localStorage.getItem(key);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (e) {
      return [];
    }
  }

  async function toggleSaveTool() {
    if (!currentUser) return;

    // Determine current saved state (prefer cloud, fallback local)
    let currentlySaved = false;
    let items = [];

    try {
      items = await fetchSavedItemsFromCloud();
      currentlySaved = items.some(x => x.tool_slug === TOOL_SLUG);
    } catch (e) {
      items = readLocalSavedItems();
      currentlySaved = items.some(x => x.tool_slug === TOOL_SLUG);
    }

    // Toggle
    if (!currentlySaved) {
      const payload = {
        user_id: currentUser.id,
        item_type: TOOL_TYPE,
        tool_slug: TOOL_SLUG,
        title: TOOL_TITLE,
        link: window.location.pathname.split("/").pop() || `${TOOL_SLUG}.html`,
      };

      // Try cloud insert (cross-device)
      try {
        const { error } = await supabase.from(TABLE_SAVED).upsert(payload, { onConflict: "user_id,tool_slug" });
        if (error) throw error;
        setSaveStatus("good", "Saved to My Playbook", true);
        await hydrateSavedItems();
        return;
      } catch (e) {
        // Local fallback
        const local = readLocalSavedItems();
        const now = new Date().toISOString();
        local.unshift({ ...payload, saved_at: now });
        writeLocalSavedItems(local);
        renderSavedItems(local);
        updateSaveButtonState(true);
        setSaveStatus("warn", "Saved locally • will sync when tables exist", true);
        return;
      }
    }

    // Remove
    try {
      const { error } = await supabase
        .from(TABLE_SAVED)
        .delete()
        .eq("user_id", currentUser.id)
        .eq("tool_slug", TOOL_SLUG);

      if (error) throw error;
      setSaveStatus("good", "Removed from My Playbook", true);
      await hydrateSavedItems();
      return;
    } catch (e) {
      // Local fallback remove
      const local = readLocalSavedItems().filter(x => x.tool_slug !== TOOL_SLUG);
      writeLocalSavedItems(local);
      renderSavedItems(local);
      updateSaveButtonState(false);
      setSaveStatus("warn", "Removed locally • will sync later", true);
    }
  }

  function updateSaveButtonState(isSaved) {
    const btn = document.getElementById("saveBtn");
    if (!btn) return;
    const icon = btn.querySelector("i");
    const label = btn.querySelector("span");

    if (isSaved) {
      btn.classList.add("saved");
      icon?.classList.remove("far");
      icon?.classList.add("fas");
      if (label) label.textContent = "Saved";
    } else {
      btn.classList.remove("saved");
      icon?.classList.remove("fas");
      icon?.classList.add("far");
      if (label) label.textContent = "Save item";
    }
  }

  function renderSavedItems(items) {
    const listEl = document.getElementById("savedItemsList");
    const emptyEl = document.getElementById("savedItemsEmpty");
    if (!listEl || !emptyEl) return;

    listEl.innerHTML = "";

    if (!items || !items.length) {
      emptyEl.style.display = "block";
      return;
    }

    emptyEl.style.display = "none";

    items.forEach(item => {
      const li = document.createElement("li");
      li.className = "saved-item";
      const savedDate = item.saved_at ? new Date(item.saved_at) : null;
      const dateText = savedDate
        ? savedDate.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })
        : "";

      li.innerHTML = `
        <div class="saved-item-title-row">
          <span class="saved-item-title">${escapeHtml(item.title || "")}</span>
          <span class="saved-item-type">${escapeHtml((item.item_type || "tool").toUpperCase())}</span>
        </div>
        <div class="saved-item-meta">${dateText ? `Saved on ${escapeHtml(dateText)}` : ""}</div>
        <a class="saved-item-link" href="${escapeAttr(item.link || "#")}">Open <i class="fas fa-arrow-right"></i></a>
      `;
      listEl.appendChild(li);
    });
  }

  /* =========================================================
     10) TOOL PROGRESS — CROSS DEVICE (Supabase) + Local fallback
     Missing thing #3 + #4 + #5
  ========================================================= */
  async function hydrateToolProgress() {
    if (!currentUser) return;

    setSaveStatus("good", "Loading your saved progress…", true);

    // 1) Try cloud
    const cloudState = await loadProgressFromCloud().catch(() => null);

    if (cloudState?.data) {
      applyChecklistState(cloudState.data);
      // Mirror to local cache
      writeLocalProgressCache(cloudState.data);
      lastSavedAt = cloudState.updated_at ? new Date(cloudState.updated_at) : null;
      setSaveStatus("good", lastSavedAt ? `Loaded • saved ${formatAgo(lastSavedAt)} ago` : "Loaded", true);
      return;
    }

    // 2) Fallback local cache
    const local = readLocalProgressCache();
    if (local) {
      applyChecklistState(local);
      setSaveStatus(navigator.onLine ? "warn" : "warn", "Loaded local progress • will sync", true);

      // Attempt sync if online (best effort)
      if (navigator.onLine) queueProgressSave("sync");
      return;
    }

    setSaveStatus("good", "No saved progress yet", true);
  }

  async function loadProgressFromCloud() {
    const { data, error } = await supabase
      .from(TABLE_PROGRESS)
      .select("data,updated_at")
      .eq("user_id", currentUser.id)
      .eq("tool_slug", TOOL_SLUG)
      .maybeSingle();

    if (error) throw error;
    return data;
  }

  function buildProgressPayload(extra = {}) {
    const dims = computeDimensionScores();
    const score = computeCapacityScore();
    const reportActive = document.getElementById("evidenceSummary")?.classList.contains("active") || false;

    return {
      version: TOOL_DATA_VERSION,
      checkedItems: checkedItems.slice(),
      capacityScore: score,
      dimensionScores: dims,
      reportGenerated: reportActive,
      ...extra
    };
  }

  function writeLocalProgressCache(payload) {
    try {
      const key = `${LS_CACHE_PREFIX}:progress:${currentUser.id}:${TOOL_SLUG}`;
      localStorage.setItem(key, JSON.stringify(payload));
      // track local timestamp so we can show "Saved locally"
      localStorage.setItem(`${key}:ts`, new Date().toISOString());
    } catch (e) {}
  }

  function readLocalProgressCache() {
    try {
      const key = `${LS_CACHE_PREFIX}:progress:${currentUser?.id || "anon"}:${TOOL_SLUG}`;
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === "object" ? parsed : null;
    } catch (e) {
      return null;
    }
  }

  function queueProgressSave(reason = "change") {
    // Immediate local save (so nothing is lost) — missing thing #4
    const payload = buildProgressPayload({ lastReason: reason });
    writeLocalProgressCache(payload);

    // If offline, stop
    if (!navigator.onLine) {
      setSaveStatus("warn", "Offline • saved locally", true);
      lastSaveSource = "local";
      return;
    }

    // Debounce cloud save
    if (saveTimer) clearTimeout(saveTimer);

    setSaveStatus("good", "Saving…", true);

    saveTimer = setTimeout(async () => {
      await saveProgressToCloud(payload);
    }, 650);
  }

  async function saveProgressToCloud(payload) {
    if (!currentUser) return;
    if (inFlightSave) return; // prevent pileups
    inFlightSave = true;

    try {
      const row = {
        user_id: currentUser.id,
        tool_slug: TOOL_SLUG,
        data: payload
      };

      const { error } = await supabase
        .from(TABLE_PROGRESS)
        .upsert(row, { onConflict: "user_id,tool_slug" });

      if (error) throw error;

      lastSavedAt = new Date();
      lastSaveSource = "cloud";
      setSaveStatus("good", `Saved • just now`, true);
    } catch (e) {
      // If table doesn't exist yet (or RLS not ready), we keep local as source of truth
      lastSaveSource = "local";
      setSaveStatus("warn", "Saved locally • cloud not ready", true);
      console.warn("Cloud save failed (expected until tables exist):", e?.message || e);
    } finally {
      inFlightSave = false;
    }
  }

  /* =========================================================
     11) SAVE STATUS CHIP UI
  ========================================================= */
  function setSaveStatus(mode, text, show = false) {
    const chip = document.getElementById("saveStatusChip");
    const t = document.getElementById("saveStatusText");
    if (!chip || !t) return;

    chip.classList.remove("good", "warn", "bad");
    chip.classList.add(mode);
    t.textContent = text;

    if (show) {
      chip.classList.add("show");
      // fade out slowly for non-critical statuses
      if (mode === "good") {
        setTimeout(() => chip.classList.remove("show"), 2200);
      }
    }
  }

  function formatAgo(date) {
    try {
      const diffMs = Date.now() - date.getTime();
      const sec = Math.round(diffMs / 1000);
      if (sec < 10) return "just now";
      if (sec < 60) return `${sec}s`;
      const min = Math.round(sec / 60);
      if (min < 60) return `${min}m`;
      const hr = Math.round(min / 60);
      return `${hr}h`;
    } catch { return ""; }
  }

  /* =========================================================
     12) MOBILE NAV
  ========================================================= */
  function initializeMobileNav() {
    const mobileToggle = document.querySelector(".mobile-toggle");
    const navLinks = document.querySelector(".nav-links");

    if (mobileToggle && navLinks) {
      mobileToggle.addEventListener("click", function () {
        navLinks.classList.toggle("active");
        const icon = this.querySelector("i");
        if (icon) {
          icon.classList.toggle("fa-bars");
          icon.classList.toggle("fa-times");
        }
      });

      document.addEventListener("click", function(event) {
        if (navLinks.classList.contains("active") &&
            !navLinks.contains(event.target) &&
            !mobileToggle.contains(event.target)) {
          navLinks.classList.remove("active");
          const icon = mobileToggle.querySelector("i");
          if (icon) {
            icon.classList.add("fa-bars");
            icon.classList.remove("fa-times");
          }
        }
      });
    }
  }

  /* =========================================================
     13) THEME TOGGLE + LOGO (consistent with html.dark-mode)
  ========================================================= */
  function initializeThemeToggle() {
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    if (!themeToggleBtn) return;

    const themeIcon = themeToggleBtn.querySelector("i");
    const logoImg = document.getElementById("mainLogo");

    function getLogoPath(filename) {
      if (window.location.protocol === "file:") {
        const currentPath = window.location.pathname;
        const basePath = currentPath.substring(0, currentPath.lastIndexOf("/") + 1);
        return basePath + "assets/img/" + filename;
      }
      return "./assets/img/" + filename;
    }

    function updateLogoForTheme(isDarkMode) {
      if (!logoImg) return;
      logoImg.classList.remove("fallback");
      logoImg.src = isDarkMode ? getLogoPath("logo-dark.png") : getLogoPath("logo.png");
      logoImg.alt = "The Employee Playbook";
    }

    const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
    const savedTheme = localStorage.getItem("theme");
    const useDark = savedTheme ? savedTheme === "dark" : prefersDarkScheme.matches;

    if (useDark) {
      document.documentElement.classList.add("dark-mode");
      themeIcon?.classList.remove("fa-moon");
      themeIcon?.classList.add("fa-sun");
      updateLogoForTheme(true);
    } else {
      document.documentElement.classList.remove("dark-mode");
      themeIcon?.classList.remove("fa-sun");
      themeIcon?.classList.add("fa-moon");
      updateLogoForTheme(false);
    }

    themeToggleBtn.addEventListener("click", function() {
      const isDarkMode = document.documentElement.classList.contains("dark-mode");
      if (isDarkMode) {
        document.documentElement.classList.remove("dark-mode");
        localStorage.setItem("theme", "light");
        themeIcon?.classList.remove("fa-sun");
        themeIcon?.classList.add("fa-moon");
        updateLogoForTheme(false);
      } else {
        document.documentElement.classList.add("dark-mode");
        localStorage.setItem("theme", "dark");
        themeIcon?.classList.remove("fa-moon");
        themeIcon?.classList.add("fa-sun");
        updateLogoForTheme(true);
      }
    });

    prefersDarkScheme.addEventListener("change", (e) => {
      if (!localStorage.getItem("theme")) {
        if (e.matches) {
          document.documentElement.classList.add("dark-mode");
          themeIcon?.classList.remove("fa-moon");
          themeIcon?.classList.add("fa-sun");
          updateLogoForTheme(true);
        } else {
          document.documentElement.classList.remove("dark-mode");
          themeIcon?.classList.remove("fa-sun");
          themeIcon?.classList.add("fa-moon");
          updateLogoForTheme(false);
        }
      }
    });

    if (logoImg) {
      logoImg.addEventListener("error", function() {
        // If dark logo fails, try light; if that fails, fallback
        if (this.src.includes("logo-dark.png")) {
          this.src = getLogoPath("logo.png");
        } else {
          this.classList.add("fallback");
        }
      });
    }
  }

  /* =========================================================
     14) SAFETY HELPERS (missing thing #5)
  ========================================================= */
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function escapeAttr(str) {
    // safe enough for href in this context
    return String(str).replaceAll('"', "&quot;");
  }

  // One more: attempt sync on unload (best effort)
  window.addEventListener("beforeunload", () => {
    try {
      const payload = buildProgressPayload({ lastReason: "unload" });
      writeLocalProgressCache(payload);
      // We avoid async supabase calls here because browsers may kill them.
    } catch (e) {}
  });
</script>
</body>
</html>
